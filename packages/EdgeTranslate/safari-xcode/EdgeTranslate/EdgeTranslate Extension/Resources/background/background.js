(()=>{"use strict";var t=Object.defineProperty,e=(e,s,n)=>(((e,s,n)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[s]=n})(e,"symbol"!=typeof s?s+"":s,n),n);const s=()=>{const t=function(t){"string"==typeof t&&(t={url:t,method:"GET"});const{url:e,method:s="GET",data:n,headers:a={},timeout:r=0,params:i,responseType:o="json",baseURL:c="",validateStatus:l=(t=>t>=200&&t<300)}=t;let h=c?c+e:e;if(i){const t=new URLSearchParams(i);h+=(h.includes("?")?"&":"?")+t.toString()}const u={method:s.toUpperCase(),headers:new Headers(a)};if(n&&!["GET","HEAD"].includes(u.method))if("string"==typeof n)u.body=n;else if(n instanceof FormData)u.body=n;else if(n instanceof URLSearchParams){u.body=n;const t=u.headers;t.get("content-type")||t.set("content-type","application/x-www-form-urlencoded")}else if(n instanceof ArrayBuffer||n instanceof Uint8Array)u.body=n;else{u.body=JSON.stringify(n);const t=u.headers;t.get("content-type")||t.set("content-type","application/json")}const d=new AbortController;u.signal=d.signal;let m=null;return r>0&&(m=setTimeout((()=>d.abort()),r)),fetch(h,u).then((e=>{let s;switch(m&&clearTimeout(m),o){case"text":s=e.text();break;case"blob":s=e.blob();break;case"arraybuffer":s=e.arrayBuffer();break;default:s=e.text().then((t=>{try{return t?JSON.parse(t):{}}catch{return t}}))}return s.then((s=>{const n={},a=e.headers;a&&"function"==typeof a.forEach&&a.forEach(((t,e)=>{n[e]=t}));const r={data:s,status:e.status,statusText:e.statusText,headers:n,config:t,request:{}};if(!l(e.status)){const s=new Error(`Request failed with status ${e.status}`);throw s.config=t,s.response=r,s.code=e.status>=500?"ECONNABORTED":"ERR_BAD_REQUEST",s}return r}))})).catch((e=>{if(m&&clearTimeout(m),"AbortError"===e.name){const e=new Error(`Request timeout after ${r}ms`);throw e.config=t,e.code="ECONNABORTED",{errorType:"NET_ERR",errorCode:0,errorMsg:e.message}}throw e.response?{errorType:"NET_ERR",errorCode:e.response.status||0,errorMsg:e.message||"Request failed"}:{errorType:"NET_ERR",errorCode:0,errorMsg:e.message||"Network Error"}}))};return t.get=(e,s={})=>t({...s,url:e,method:"GET"}),t.post=(e,s,n={})=>t({...n,url:e,data:s,method:"POST"}),t.put=(e,s,n={})=>t({...n,url:e,data:s,method:"PUT"}),t.patch=(e,s,n={})=>t({...n,url:e,data:s,method:"PATCH"}),t.delete=(e,s={})=>t({...s,url:e,method:"DELETE"}),t.head=(e,s={})=>t({...s,url:e,method:"HEAD"}),t.options=(e,s={})=>t({...s,url:e,method:"OPTIONS"}),t.defaults={headers:{common:{Connection:"keep-alive","Keep-Alive":"timeout=30, max=100"},get:{Accept:"application/json, text/plain, */*"},post:{"Content-Type":"application/json",Accept:"application/json, text/plain, */*"},put:{"Content-Type":"application/json",Accept:"application/json, text/plain, */*"},patch:{"Content-Type":"application/json",Accept:"application/json, text/plain, */*"}},timeout:6e3,responseType:"json",baseURL:"",validateStatus:t=>t>=200&&t<300},t.interceptors={request:{use:()=>{},eject:()=>{}},response:{use:()=>{},eject:()=>{}}},t.create=(t={})=>{const e=s();return Object.assign(e.defaults,t),e},t.isAxiosError=t=>t&&("NET_ERR"===t.errorType||t.config&&t.code),t},n=s(),a=n;class r{constructor(t=500,s=6e5){e(this,"cache",new Map),e(this,"accessOrder",new Map),e(this,"frequencies",new Map),e(this,"maxSize"),e(this,"ttl"),e(this,"accessCounter",0),this.maxSize=t,this.ttl=s}get(t){const e=this.cache.get(t);return e?Date.now()-e.timestamp>this.ttl?(this.delete(t),null):(this.accessOrder.set(t,++this.accessCounter),this.frequencies.set(t,(this.frequencies.get(t)||0)+1),e.result):null}set(t,e){this.cache.size>=this.maxSize&&!this.cache.has(t)&&this.evictLeastValuable();const s={result:e,timestamp:Date.now()};this.cache.set(t,s),this.accessOrder.set(t,++this.accessCounter),this.frequencies.set(t,(this.frequencies.get(t)||0)+1)}has(t){return null!==this.get(t)}delete(t){this.cache.delete(t),this.accessOrder.delete(t),this.frequencies.delete(t)}clear(){this.cache.clear(),this.accessOrder.clear(),this.frequencies.clear(),this.accessCounter=0}size(){return this.cache.size}getStats(){return{size:this.cache.size,maxSize:this.maxSize,ttl:this.ttl,accessCounter:this.accessCounter}}evictLeastValuable(){let t=null,e=1/0;for(const[s]of this.cache){const n=this.frequencies.get(s)||1,a=this.accessOrder.get(s)||0,r=1e3*n-(this.accessCounter-a);r<e&&(e=r,t=s)}t&&this.delete(t)}cleanExpired(){const t=Date.now();for(const[e,s]of this.cache)t-s.timestamp>this.ttl&&this.delete(e)}}class i{constructor(t){e(this,"pendingRequests",[]),e(this,"batchTimeout",null),e(this,"BATCH_DELAY",50),e(this,"MAX_BATCH_SIZE",10),e(this,"MAX_BATCH_CHARS",5e3),this.translator=t}async addRequest(t,e,s){return new Promise(((n,a)=>{this.pendingRequests.push({text:t,from:e,to:s,resolve:n,reject:a,timestamp:Date.now()});const r=this.pendingRequests.reduce(((t,e)=>t+e.text.length),0);this.pendingRequests.length>=this.MAX_BATCH_SIZE||r>=this.MAX_BATCH_CHARS?this.processBatch():this.scheduleBatchProcessing()}))}scheduleBatchProcessing(){this.batchTimeout||(this.batchTimeout=setTimeout((()=>{this.processBatch()}),this.BATCH_DELAY))}async processBatch(){if(this.batchTimeout&&(clearTimeout(this.batchTimeout),this.batchTimeout=null),0===this.pendingRequests.length)return;const t=[...this.pendingRequests];this.pendingRequests=[];try{await this.processBatchedRequests(t)}catch{for(const e of t)try{const t=await this.translator.translateSingle(e.text,e.from,e.to);e.resolve(t)}catch(t){e.reject(t)}}}async processBatchedRequests(t){const e=this.groupByLanguagePair(t),s=Object.entries(e).map((async([t,e])=>{const[s,n]=t.split("|");return this.processLanguageGroup(e,s,n)}));await Promise.allSettled(s)}groupByLanguagePair(t){return t.reduce(((t,e)=>{const s=`${e.from}|${e.to}`;return t[s]||(t[s]=[]),t[s].push(e),t}),{})}async processLanguageGroup(t,e,s){if(t.length<=3){const e=t.map((async t=>{try{const e=await this.translator.translateSingle(t.text,t.from,t.to);t.resolve(e)}catch(e){t.reject(e)}}));await Promise.allSettled(e)}else for(let e=0;e<t.length;e+=3){const s=t.slice(e,e+3).map((async t=>{try{const e=await this.translator.translateSingle(t.text,t.from,t.to);t.resolve(e)}catch(e){t.reject(e)}}));await Promise.allSettled(s)}}getStats(){return{pendingRequests:this.pendingRequests.length,batchDelay:this.BATCH_DELAY,maxBatchSize:this.MAX_BATCH_SIZE,maxBatchChars:this.MAX_BATCH_CHARS}}}class o{constructor(t){e(this,"languagePairFrequency",new Map),e(this,"textPatterns",new Map),e(this,"prefetchQueue",new Set),e(this,"MAX_PREFETCH_QUEUE",20),e(this,"PATTERN_DECAY_TIME",18e5),e(this,"MIN_FREQUENCY_FOR_PREFETCH",2),this.translator=t}learnPattern(t,e,s){const n=`${e}|${s}`;this.languagePairFrequency.set(n,(this.languagePairFrequency.get(n)||0)+1);const a=t.toLowerCase().trim().split(/\s+/).slice(0,3);if(a.length>=2){const e=a.join(" "),s=this.textPatterns.get(e)||{frequency:0,lastUsed:0,predictions:[]};s.frequency++,s.lastUsed=Date.now(),!s.predictions.includes(t)&&s.predictions.length<5&&s.predictions.push(t),this.textPatterns.set(e,s)}Math.random()<.1&&this.cleanOldPatterns()}getPrefetchSuggestions(t,e,s){const n=[],a=t.toLowerCase().trim().split(/\s+/).slice(0,3);if(a.length<2)return n;const r=a.join(" "),i=this.textPatterns.get(r);if(i&&i.frequency>=this.MIN_FREQUENCY_FOR_PREFETCH)for(const a of i.predictions)if(a!==t){const t=Math.min(i.frequency/10,.9);n.push({text:a,from:e,to:s,confidence:t})}const o=`${s}|${e}`;return this.languagePairFrequency.get(o)&&this.languagePairFrequency.get(o)>=3&&n.push({text:t,from:s,to:e,confidence:.6}),n.slice(0,3)}async prefetch(t){for(const e of t){if(this.prefetchQueue.size>=this.MAX_PREFETCH_QUEUE)break;const t=`${e.from}|${e.to}|${e.text.toLowerCase().trim()}`;this.prefetchQueue.has(t)||this.translator.hasInCache(t)||(this.prefetchQueue.add(t),setTimeout((async()=>{try{await this.translator.translateSingle(e.text,e.from,e.to)}catch(t){console.debug("Prefetch failed:",t)}finally{this.prefetchQueue.delete(t)}}),e.confidence>.8?100:500))}}cleanOldPatterns(){const t=Date.now();for(const[e,s]of this.textPatterns)t-s.lastUsed>this.PATTERN_DECAY_TIME&&this.textPatterns.delete(e)}getTopLanguagePairs(t=5){return Array.from(this.languagePairFrequency.entries()).sort((([,t],[,e])=>e-t)).slice(0,t).map((([t,e])=>({pair:t,frequency:e})))}getStats(){return{languagePairs:this.languagePairFrequency.size,textPatterns:this.textPatterns.size,prefetchQueueSize:this.prefetchQueue.size,maxPrefetchQueue:this.MAX_PREFETCH_QUEUE,patternDecayTime:this.PATTERN_DECAY_TIME,minFrequencyForPrefetch:this.MIN_FREQUENCY_FOR_PREFETCH}}}class c{constructor(){e(this,"connectionStats",{totalRequests:0,reuseCount:0,newConnections:0,timeouts:0,errors:0}),e(this,"hostConnections",new Map),e(this,"CONNECTION_TIMEOUT",3e4),e(this,"MAX_CONNECTIONS_PER_HOST",6)}trackConnection(t,e=!1){this.connectionStats.totalRequests++,e?this.connectionStats.reuseCount++:this.connectionStats.newConnections++;const s=this.hostConnections.get(t)||{lastUsed:0,activeRequests:0};s.lastUsed=Date.now(),s.activeRequests++,this.hostConnections.set(t,s)}finishConnection(t){const e=this.hostConnections.get(t);e&&e.activeRequests>0&&(e.activeRequests--,this.hostConnections.set(t,e))}trackTimeout(t){this.connectionStats.timeouts++}trackError(t){this.connectionStats.errors++}getOptimizedTimeout(t,e=!1){const s=this.hostConnections.get(t);return s&&s.lastUsed>Date.now()-this.CONNECTION_TIMEOUT?e?6e3:8e3:e?8e3:1e4}canReuseConnection(t){const e=this.hostConnections.get(t);return!!e&&Date.now()-e.lastUsed<this.CONNECTION_TIMEOUT&&e.activeRequests<this.MAX_CONNECTIONS_PER_HOST}cleanup(){const t=Date.now();for(const[e,s]of this.hostConnections)t-s.lastUsed>2*this.CONNECTION_TIMEOUT&&this.hostConnections.delete(e)}getStats(){const t=this.connectionStats.totalRequests>0?(this.connectionStats.reuseCount/this.connectionStats.totalRequests*100).toFixed(1)+"%":"0%",e=this.connectionStats.totalRequests>0?(this.connectionStats.errors/this.connectionStats.totalRequests*100).toFixed(1)+"%":"0%";return{...this.connectionStats,reuseRate:t,errorRate:e,activeHosts:this.hostConnections.size,maxConnectionsPerHost:this.MAX_CONNECTIONS_PER_HOST}}}class l{constructor(t){e(this,"metrics",{requestTimes:[],cacheHits:0,cacheMisses:0,batchEfficiency:0,connectionReuse:0,errorCount:0,prefetchHits:0,totalTranslations:0}),e(this,"performanceHistory",[]),e(this,"MAX_HISTORY_SIZE",100),e(this,"PERFORMANCE_THRESHOLD",{avgResponseTime:2e3,cacheHitRate:.7,errorRate:.05,throughput:10}),e(this,"autoOptimizationEnabled",!0),e(this,"lastOptimization",0),e(this,"OPTIMIZATION_COOLDOWN",3e5),this.translator=t}trackRequest(t,e,s,n){const a=e-t;this.metrics.requestTimes.push(a),this.metrics.totalTranslations++,s?this.metrics.cacheHits++:this.metrics.cacheMisses++,n&&this.metrics.errorCount++,this.metrics.requestTimes.length>100&&this.metrics.requestTimes.shift(),this.autoOptimizationEnabled&&this.checkAndOptimize()}trackPrefetchHit(){this.metrics.prefetchHits++}getCurrentMetrics(){const t=this.metrics.requestTimes.length>0?this.metrics.requestTimes.reduce(((t,e)=>t+e),0)/this.metrics.requestTimes.length:0,e=this.metrics.totalTranslations>0?this.metrics.cacheHits/this.metrics.totalTranslations:0,s=this.metrics.totalTranslations>0?this.metrics.errorCount/this.metrics.totalTranslations:0,n=this.performanceHistory.filter((t=>Date.now()-t.timestamp<6e4)).length;return{avgResponseTime:t,cacheHitRate:e,errorRate:s,throughput:n,totalRequests:this.metrics.totalTranslations,prefetchHits:this.metrics.prefetchHits,isPerformanceGood:this.isPerformanceGood(t,e,s,n)}}isPerformanceGood(t,e,s,n){return t<this.PERFORMANCE_THRESHOLD.avgResponseTime&&e>this.PERFORMANCE_THRESHOLD.cacheHitRate&&s<this.PERFORMANCE_THRESHOLD.errorRate&&n>this.PERFORMANCE_THRESHOLD.throughput}checkAndOptimize(){const t=Date.now();if(t-this.lastOptimization<this.OPTIMIZATION_COOLDOWN)return;const e=this.getCurrentMetrics();this.performanceHistory.push({timestamp:t,avgResponseTime:e.avgResponseTime,cacheHitRate:e.cacheHitRate,errorRate:e.errorRate,throughput:e.throughput}),this.performanceHistory.length>this.MAX_HISTORY_SIZE&&this.performanceHistory.shift(),!e.isPerformanceGood&&this.metrics.totalTranslations>10&&(this.performAutoOptimization(e),this.lastOptimization=t)}performAutoOptimization(t){const e=[];if(t.cacheHitRate<this.PERFORMANCE_THRESHOLD.cacheHitRate){const t=this.translator.getCacheStats();t.size>=.9*t.maxSize&&e.push("Increased cache TTL for better hit rate")}t.avgResponseTime>this.PERFORMANCE_THRESHOLD.avgResponseTime&&this.translator.REQUEST_DELAY>100&&(this.translator.REQUEST_DELAY=Math.max(100,this.translator.REQUEST_DELAY-50),e.push(`Reduced request delay to ${this.translator.REQUEST_DELAY}ms`)),e.length>0&&console.debug("Auto-optimization applied:",e)}getPerformanceTrends(t=10){const e=this.performanceHistory.slice(-t);if(e.length<2)return{trend:"stable",confidence:0};const s=e.slice(0,Math.floor(e.length/2)),n=e.slice(Math.floor(e.length/2)),a=s.reduce(((t,e)=>t+e.avgResponseTime),0)/s.length,r=(a-n.reduce(((t,e)=>t+e.avgResponseTime),0)/n.length)/a;return r>.1?{trend:"improving",confidence:Math.min(100*r,100)}:r<-.1?{trend:"degrading",confidence:Math.min(100*Math.abs(r),100)}:{trend:"stable",confidence:90}}getOptimizationRecommendations(){const t=this.getCurrentMetrics(),e=[];return t.cacheHitRate<.5&&e.push("Consider increasing cache size or TTL"),t.avgResponseTime>3e3&&e.push("Network performance issues detected - check connection"),t.errorRate>.1&&e.push("High error rate - consider implementing circuit breaker"),t.throughput<5&&e.push("Low throughput - consider enabling more aggressive batching"),e}reset(){this.metrics={requestTimes:[],cacheHits:0,cacheMisses:0,batchEfficiency:0,connectionReuse:0,errorCount:0,prefetchHits:0,totalTranslations:0},this.performanceHistory=[]}setAutoOptimization(t){this.autoOptimizationEnabled=t}getPerformanceReport(){return{currentMetrics:this.getCurrentMetrics(),trends:this.getPerformanceTrends(),recommendations:this.getOptimizationRecommendations(),autoOptimizationEnabled:this.autoOptimizationEnabled,lastOptimization:this.lastOptimization,performanceHistory:this.performanceHistory.slice(-10)}}}const h=[["auto","auto-detect"],["ar","ar"],["ga","ga"],["et","et"],["or","or"],["bg","bg"],["is","is"],["pl","pl"],["bs","bs-Latn"],["fa","fa"],["prs","prs"],["da","da"],["de","de"],["ru","ru"],["fr","fr"],["zh-TW","zh-Hant"],["fil","fil"],["fj","fj"],["fi","fi"],["gu","gu"],["kk","kk"],["ht","ht"],["ko","ko"],["nl","nl"],["ca","ca"],["zh-CN","zh-Hans"],["cs","cs"],["kn","kn"],["otq","otq"],["tlh","tlh"],["hr","hr"],["lv","lv"],["lt","lt"],["ro","ro"],["mg","mg"],["mt","mt"],["mr","mr"],["ml","ml"],["ms","ms"],["mi","mi"],["bn","bn-BD"],["hmn","mww"],["af","af"],["pa","pa"],["pt","pt"],["ps","ps"],["ja","ja"],["sv","sv"],["sm","sm"],["sr-Latn","sr-Latn"],["sr-Cyrl","sr-Cyrl"],["no","nb"],["sk","sk"],["sl","sl"],["sw","sw"],["ty","ty"],["te","te"],["ta","ta"],["th","th"],["to","to"],["tr","tr"],["cy","cy"],["ur","ur"],["uk","uk"],["es","es"],["he","iw"],["el","el"],["hu","hu"],["it","it"],["hi","hi"],["id","id"],["en","en"],["yua","yua"],["yue","yua"],["vi","vi"],["ku","ku"],["kmr","kmr"]],u={ar:["ar-SA","Male","ar-SA-Naayf"],bg:["bg-BG","Male","bg-BG-Ivan"],ca:["ca-ES","Female","ca-ES-HerenaRUS"],cs:["cs-CZ","Male","cs-CZ-Jakub"],da:["da-DK","Female","da-DK-HelleRUS"],de:["de-DE","Female","de-DE-Hedda"],el:["el-GR","Male","el-GR-Stefanos"],en:["en-US","Female","en-US-JessaRUS"],es:["es-ES","Female","es-ES-Laura-Apollo"],fi:["fi-FI","Female","fi-FI-HeidiRUS"],fr:["fr-FR","Female","fr-FR-Julie-Apollo"],he:["he-IL","Male","he-IL-Asaf"],hi:["hi-IN","Female","hi-IN-Kalpana-Apollo"],hr:["hr-HR","Male","hr-HR-Matej"],hu:["hu-HU","Male","hu-HU-Szabolcs"],id:["id-ID","Male","id-ID-Andika"],it:["it-IT","Male","it-IT-Cosimo-Apollo"],ja:["ja-JP","Female","ja-JP-Ayumi-Apollo"],ko:["ko-KR","Female","ko-KR-HeamiRUS"],ms:["ms-MY","Male","ms-MY-Rizwan"],nl:["nl-NL","Female","nl-NL-HannaRUS"],nb:["nb-NO","Female","nb-NO-HuldaRUS"],no:["nb-NO","Female","nb-NO-HuldaRUS"],pl:["pl-PL","Female","pl-PL-PaulinaRUS"],pt:["pt-PT","Female","pt-PT-HeliaRUS"],ro:["ro-RO","Male","ro-RO-Andrei"],ru:["ru-RU","Female","ru-RU-Irina-Apollo"],sk:["sk-SK","Male","sk-SK-Filip"],sl:["sl-SL","Male","sl-SI-Lado"],sv:["sv-SE","Female","sv-SE-HedvigRUS"],ta:["ta-IN","Female","ta-IN-Valluvar"],te:["te-IN","Male","te-IN-Chitra"],th:["th-TH","Male","th-TH-Pattara"],tr:["tr-TR","Female","tr-TR-SedaRUS"],vi:["vi-VN","Male","vi-VN-An"],"zh-Hans":["zh-CN","Female","zh-CN-HuihuiRUS"],"zh-Hant":["zh-CN","Female","zh-CN-HuihuiRUS"],yue:["zh-HK","Female","zh-HK-TracyRUS"]},d={ar:"ar-EG",ca:"ca-ES",da:"da-DK",de:"de-DE",en:"en-US",es:"es-ES",fi:"fi-FI",fr:"fr-FR",hi:"hi-IN",it:"it-IT",ja:"ja-JP",ko:"ko-KR",nb:"nb-NO",nl:"nl-NL",pl:"pl-PL",pt:"pt-PT",ru:"ru-RU",sv:"sv-SE",th:"th-TH","zh-Hans":"zh-CN","zh-Hant":"zh-HK",yue:"zh-HK",gu:"gu-IN",mr:"mr-IN",ta:"ta-IN",te:"te-IN",tr:"tr-TR"};class m{constructor(){e(this,"IG",""),e(this,"IID",""),e(this,"token",""),e(this,"key",""),e(this,"batcher"),e(this,"prefetcher"),e(this,"connectionPool"),e(this,"performanceMonitor"),e(this,"tokensInitiated",!1),e(this,"tokenInitPromise",null),e(this,"cache"),e(this,"CACHE_TTL",6e5),e(this,"warmupInProgress",!1),e(this,"poolStats",{requests:0,cacheHits:0,errors:0}),e(this,"TTS_AUTH",{region:"",token:""}),e(this,"count",0),e(this,"lastRequestTime",0),e(this,"REQUEST_DELAY",200),e(this,"FIRST_REQUEST_TIMEOUT",8e3),e(this,"HTMLParser",new DOMParser),e(this,"MAX_RETRY",1),e(this,"HOST","https://www.bing.com/"),e(this,"HOME_PAGE","https://www.bing.com/translator"),e(this,"HEADERS",{accept:"application/json, text/plain, */*","accept-language":"en-US,en;q=0.9,ko;q=0.8,zh-CN;q=0.7,zh;q=0.6","content-type":"application/x-www-form-urlencoded","user-agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 Edg/120.0.0.0","accept-encoding":"gzip, deflate, br","cache-control":"no-cache",origin:"https://www.bing.com",referer:"https://www.bing.com/translator","sec-ch-ua":'"Not_A Brand";v="8", "Chromium";v="120", "Microsoft Edge";v="120"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"macOS"',"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-origin",connection:"keep-alive","keep-alive":"timeout=30, max=100","x-dns-prefetch-control":"on"}),e(this,"LAN_TO_CODE",new Map(h)),e(this,"CODE_TO_LAN",new Map(h.map((([t,e])=>[e,t])))),e(this,"AUDIO",new Audio),this.cache=new r(500,this.CACHE_TTL),this.batcher=new i(this),this.prefetcher=new o(this),this.connectionPool=new c,this.performanceMonitor=new l(this)}async updateTokens(){if(this.tokenInitPromise)await this.tokenInitPromise;else{this.tokenInitPromise=this._doUpdateTokens();try{await this.tokenInitPromise}finally{this.tokenInitPromise=null}}}async warmUp(){if(!this.tokensInitiated&&!this.warmupInProgress){this.warmupInProgress=!0;try{await this.updateTokens()}catch(t){console.debug("Bing translator warmup failed:",t)}finally{this.warmupInProgress=!1}}}async _doUpdateTokens(){const t=await a.get(this.HOME_PAGE,{timeout:6e3}),e=/(https:\/\/.*\.bing\.com\/).*/g.exec(t.request.responseURL);e&&e[1]!=this.HOST&&(this.HOST=e[1],this.HOME_PAGE=`${this.HOST}translator`);const s=t.data.match(/IG:"([A-Za-z0-9]+)"/);if(!s)throw new Error("Failed to extract IG token");this.IG=s[1];const n=t.data.match(/var params_AbusePreventionHelper\s*=\s*\[([0-9]+),\s*"([^"]+)",[^\]]*\];/);if(!n)throw new Error("Failed to extract abuse prevention params");[,this.key,this.token]=n;const r=t.data.match(/data-iid="([^"]+)"/);this.IID=r?r[1]:"",this.count=0}parseTranslateResult(t,e){const s=e||new Object;try{const e=t[0].translations;s.mainMeaning=e[0].text,s.tPronunciation=e[0].transliteration.text}catch{}return s}parseLookupResult(t,e){const s=e||new Object;try{s.originalText=t[0].displaySource;const e=t[0].translations;s.mainMeaning=e[0].displayTarget,s.tPronunciation=e[0].transliteration;const n=[];for(const t in e){const s=[];for(const n in e[t].backTranslations)s.push(e[t].backTranslations[n].displayText);n.push({pos:e[t].posTag,meaning:e[t].displayTarget,synonyms:s})}s.detailedMeanings=n}catch{}return s}parseExampleResult(t,e){const s=e||new Object;try{s.examples=t[0].examples.map((t=>({source:`${t.sourcePrefix}<b>${t.sourceTerm}</b>${t.sourceSuffix}`,target:`${t.targetPrefix}<b>${t.targetTerm}</b>${t.targetSuffix}`})))}catch{}return s}async updateTTSAuth(){const t=await this.request((()=>({method:"POST",baseURL:this.HOST,url:`tfetspktok?isVertical=1&&IG=${this.IG}&IID=${this.IID}.${this.count.toString()}`,headers:this.HEADERS,data:`&token=${encodeURIComponent(this.token)}&key=${encodeURIComponent(this.key)}`})),[]);this.TTS_AUTH.region=t.region,this.TTS_AUTH.token=t.token}generateTTSData(t,e,s){const n=this.LAN_TO_CODE.get(e),a=u[n],r=d[n],i="fast"===s?"-10.00%":"-30.00%";return`<speak version='1.0' xml:lang='${r}'><voice xml:lang='${r}' xml:gender='${a[1]}' name='${a[2]}'><prosody rate='${i}'>${t}</prosody></voice></speak>`}arrayBufferToBase64(t){let e="",s=new Uint8Array(t);for(let t=0;t<s.byteLength;t++)e+=String.fromCharCode(s[t]);return btoa(e)}constructDetectParams(t){const e=`ttranslatev3?isVertical=1&IG=${this.IG}&IID=${this.IID}.${this.count.toString()}`,s=`&fromLang=auto-detect&to=zh-Hans&text=${encodeURIComponent(t)}&token=${encodeURIComponent(this.token)}&key=${encodeURIComponent(this.key)}`;return{method:"POST",baseURL:this.HOST,url:e,headers:this.HEADERS,data:s}}constructTranslateParams(t,e,s){const n=`ttranslatev3?isVertical=1&IG=${this.IG}&IID=${this.IID}.${this.count.toString()}`,a=`&fromLang=${this.LAN_TO_CODE.get(e)}&to=${this.LAN_TO_CODE.get(s)}&text=${encodeURIComponent(t)}&token=${encodeURIComponent(this.token)}&key=${encodeURIComponent(this.key)}`;return{method:"POST",baseURL:this.HOST,url:n,headers:this.HEADERS,data:a}}constructLookupParams(t,e,s){const n=`tlookupv3?isVertical=1&IG=${this.IG}&IID=${this.IID}.${this.count.toString()}`,a=`&from=${e}&to=${this.LAN_TO_CODE.get(s)}&text=${encodeURIComponent(t)}&token=${encodeURIComponent(this.token)}&key=${encodeURIComponent(this.key)}`;return{method:"POST",baseURL:this.HOST,url:n,headers:this.HEADERS,data:a}}constructExampleParams(t,e,s,n){const a=`texamplev3?isVertical=1&IG=${this.IG}&IID=${this.IID}.${this.count.toString()}`,r=`&from=${t}&to=${this.LAN_TO_CODE.get(e)}&text=${encodeURIComponent(s)}&translation=${encodeURIComponent(n)}&token=${encodeURIComponent(this.token)}&key=${encodeURIComponent(this.key)}`;return{method:"POST",baseURL:this.HOST,url:a,headers:this.HEADERS,data:r}}constructTTSParams(t,e,s){return{method:"POST",baseURL:`https://${this.TTS_AUTH.region}.tts.speech.microsoft.com/cognitiveservices/v1?`,headers:{"Content-Type":"application/ssml+xml",Authorization:`Bearer ${this.TTS_AUTH.token}`,"X-MICROSOFT-OutputFormat":"audio-16khz-32kbitrate-mono-mp3","cache-control":"no-cache"},data:this.generateTTSData(t,e,s),responseType:"arraybuffer"}}async request(t,e,s=!0){const n=Date.now()-this.lastRequestTime;if(n<this.REQUEST_DELAY&&this.count>2){const t=this.REQUEST_DELAY-n;await new Promise((e=>setTimeout(e,t)))}this.lastRequestTime=Date.now();let r=0;const i=async()=>{var s;this.count++;const n=this.count<=3,r=this.connectionPool.getOptimizedTimeout(this.HOST,n),i=this.connectionPool.canReuseConnection(this.HOST);this.connectionPool.trackConnection(this.HOST,i);try{const s=await a({timeout:r,...t.call(this,...e)});return this.connectionPool.finishConnection(this.HOST),s}catch(t){throw"ECONNABORTED"===t.code||(null==(s=t.message)?void 0:s.includes("timeout"))?this.connectionPool.trackTimeout(this.HOST):this.connectionPool.trackError(this.HOST),this.connectionPool.finishConnection(this.HOST),t}},o=async t=>{if(401===t.status||429===t.status)throw{errorType:"API_ERR",errorCode:t.status,errorMsg:"Request too frequently!"};const e=/(https:\/\/.*\.bing\.com\/).*/g.exec(t.request.responseURL);if(e&&e[1]!==this.HOST)return this.HOST=e[1],this.HOME_PAGE=`${this.HOST}translator`,await this.updateTokens().then(i);const n=t.data.StatusCode||t.data.statusCode||200;switch(n){case 200:return t.data;case 205:return await this.updateTokens().then(i)}if(s&&r<this.MAX_RETRY)return r++,await this.updateTokens().then(i);throw{errorType:"API_ERR",errorCode:n,errorMsg:"Request failed."}};return Math.random()<.05&&this.connectionPool.cleanup(),await(async()=>{this.tokensInitiated||(await this.updateTokens(),this.tokensInitiated=!0)})(),(async()=>{const t=await i();return await o(t)})()}supportedLanguages(){return new Set(this.LAN_TO_CODE.keys())}async detect(t){try{const e=(await this.request(this.constructDetectParams,[t]))[0].detectedLanguage.language;return this.CODE_TO_LAN.get(e)}catch(e){throw e.errorMsg=e.errorMsg||e.message,e.errorAct={api:"bing",action:"detect",text:t,from:null,to:null},e}}clearExpiredCache(){this.cache.cleanExpired()}async fastTranslate(t,e,s){let n;try{n=await this.request(this.constructTranslateParams,[t,e,s])}catch(n){throw this.poolStats.errors++,n.errorAct={api:"bing",action:"translate",text:t,from:e,to:s},n}return this.parseTranslateResult(n,{originalText:t,mainMeaning:""})}async translate(t,e,s){const n=Date.now(),a=`${e}|${s}|${t.toLowerCase().trim()}`,r=this.cache.get(a);if(r){this.poolStats.cacheHits++,this.performanceMonitor.trackRequest(n,Date.now(),!0),this.performanceMonitor.trackPrefetchHit(),this.prefetcher.learnPattern(t,e,s);const a=this.prefetcher.getPrefetchSuggestions(t,e,s);return a.length>0&&this.prefetcher.prefetch(a).catch((()=>{})),r}this.prefetcher.learnPattern(t,e,s);const i=this.prefetcher.getPrefetchSuggestions(t,e,s);i.length>0&&this.prefetcher.prefetch(i).catch((()=>{}));try{const a=await this.batcher.addRequest(t,e,s);return this.performanceMonitor.trackRequest(n,Date.now(),!1),a}catch(t){throw this.performanceMonitor.trackRequest(n,Date.now(),!1,!0),t}}async translateSingle(t,e,s){this.poolStats.requests++;const n=`${e}|${s}|${t.toLowerCase().trim()}`,a=this.cache.get(n);if(a)return this.poolStats.cacheHits++,a;if(Math.random()<.1&&this.clearExpiredCache(),this.count<=2){const a=await this.fastTranslate(t,e,s);return this.cache.set(n,a),a}let r;try{r=await this.request(this.constructTranslateParams,[t,e,s])}catch(n){throw this.poolStats.errors++,n.errorAct={api:"bing",action:"translate",text:t,from:e,to:s},n}const i=this.parseTranslateResult(r,{originalText:t,mainMeaning:""});if(!(t.trim().split(/\s+/).length<=3))return this.cache.set(n,i),i;try{const e=r[0].detectedLanguage.language,[a,o]=await Promise.allSettled([this.request(this.constructLookupParams,[t,e,s],!1).then((t=>({type:"lookup",response:t}))),i.mainMeaning?this.request(this.constructExampleParams,[e,s,t,i.mainMeaning],!1).then((t=>({type:"example",response:t}))):Promise.reject("No main meaning")]);let c=i;return"fulfilled"===a.status&&(c=this.parseLookupResult(a.value.response,c)),"fulfilled"===o.status&&(c=this.parseExampleResult(o.value.response,c)),this.cache.set(n,c),c}catch{return this.cache.set(n,i),i}}async pronounce(t,e,s){this.stopPronounce();let n=0;const a=async()=>{try{const n=await this.request(this.constructTTSParams,[t,e,s],!1);this.AUDIO.src=`data:audio/mp3;base64,${this.arrayBufferToBase64(n)}`,await this.AUDIO.play()}catch(s){if(n<this.MAX_RETRY)return n++,this.updateTTSAuth().then(a);const r={api:"bing",action:"pronounce",text:t,from:e,to:null};throw s.errorType?(s.errorAct=r,s):{errorType:"NET_ERR",errorCode:0,errorMsg:s.message,errorAct:r}}};return this.TTS_AUTH.region.length>0&&this.TTS_AUTH.token.length>0||await this.updateTTSAuth(),a()}stopPronounce(){this.AUDIO.paused||this.AUDIO.pause()}getPoolStats(){const t=this.cache.getStats(),e=this.batcher.getStats(),s=this.prefetcher.getStats(),n=this.connectionPool.getStats(),a=this.performanceMonitor.getCurrentMetrics();return{...this.poolStats,cacheSize:t.size,maxCacheSize:t.maxSize,cacheTTL:t.ttl,accessCounter:t.accessCounter,hitRate:this.poolStats.requests>0?(this.poolStats.cacheHits/this.poolStats.requests*100).toFixed(1)+"%":"0%",batcher:e,prefetcher:s,topLanguagePairs:this.prefetcher.getTopLanguagePairs(3),connectionPool:n,performance:a}}getPerformanceReport(){return this.performanceMonitor.getPerformanceReport()}setAutoOptimization(t){this.performanceMonitor.setAutoOptimization(t)}resetPerformanceMetrics(){this.performanceMonitor.reset()}hasInCache(t){return this.cache.has(t)}getCacheStats(){return this.cache.getStats()}async cleanup(){this.cache.clear()}}class g{constructor(t){e(this,"map"),e(this,"max"),e(this,"ttl"),e(this,"now"),this.max=Math.max(1,0|t.max),this.ttl=t.ttl,this.now=t.now||Date.now,this.map=new Map}get(t){const e=this.map.get(t);if(e)return null!=e.expiresAt&&e.expiresAt<=this.now()?void this.map.delete(t):(this.map.delete(t),this.map.set(t,e),e.value)}set(t,e){const s=this.ttl?this.now()+this.ttl:null;if(this.map.has(t)&&this.map.delete(t),this.map.set(t,{value:e,expiresAt:s}),this.map.size>this.max){const t=this.map.keys().next();t.done||this.map.delete(t.value)}}has(t){return void 0!==this.get(t)}size(){return this.map.size}clear(){this.map.clear()}}function p(t){let e=2166136261;for(let s=0;s<t.length;s++)e^=t.charCodeAt(s),e=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24)+(e>>>0);return(e>>>0).toString(16)}const f=[["auto","auto"],["zh-CN","zh-CN"],["zh-TW","zh-TW"],["en","en"],["af","af"],["am","am"],["ar","ar"],["az","az"],["be","be"],["bg","bg"],["bn","bn"],["bs","bs"],["ca","ca"],["ceb","ceb"],["co","co"],["cs","cs"],["cy","cy"],["da","da"],["de","de"],["el","el"],["eo","eo"],["es","es"],["et","et"],["eu","eu"],["fa","fa"],["fi","fi"],["fr","fr"],["fy","fy"],["ga","ga"],["gd","gd"],["gl","gl"],["gu","gu"],["ha","ha"],["haw","haw"],["he","he"],["hi","hi"],["hmn","hmn"],["hr","hr"],["ht","ht"],["hu","hu"],["hy","hy"],["id","id"],["ig","ig"],["is","is"],["it","it"],["ja","ja"],["jw","jw"],["ka","ka"],["kk","kk"],["km","km"],["kn","kn"],["ko","ko"],["ku","ku"],["ky","ky"],["la","la"],["lb","lb"],["lo","lo"],["lt","lt"],["lv","lv"],["mg","mg"],["mi","mi"],["mk","mk"],["ml","ml"],["mn","mn"],["mr","mr"],["ms","ms"],["mt","mt"],["my","my"],["ne","ne"],["nl","nl"],["no","no"],["ny","ny"],["pl","pl"],["ps","ps"],["pt","pt"],["ro","ro"],["ru","ru"],["sd","sd"],["si","si"],["sk","sk"],["sl","sl"],["sm","sm"],["sn","sn"],["so","so"],["sq","sq"],["sr","sr"],["st","st"],["su","su"],["sv","sv"],["sw","sw"],["ta","ta"],["te","te"],["tg","tg"],["th","th"],["fil","tl"],["tr","tr"],["ug","ug"],["uk","uk"],["ur","ur"],["uz","uz"],["vi","vi"],["xh","xh"],["yi","yi"],["yo","yo"],["zu","zu"]];class T{constructor(){e(this,"TKK",[434217,1534559001]),e(this,"HOME_PAGE","https://translate.google.com/"),e(this,"HOST","https://translate.googleapis.com/"),e(this,"TRANSLATE_URL",`${this.HOST}translate_a/single?client=gtx&dj=1&dt=t&dt=at&dt=bd&dt=ex&dt=md&dt=rw&dt=ss&dt=rm`),e(this,"TTS_URL",`${this.HOST}translate_tts?client=gtx`),e(this,"FALLBACK_TRANSLATE_URL",`${this.HOST}translate_a/single?ie=UTF-8&client=webapp&otf=1&ssel=0&tsel=0&kc=5&dt=t&dt=at&dt=bd&dt=ex&dt=md&dt=rw&dt=ss&dt=rm`),e(this,"FALLBACK_TTS_URL",`${this.HOST}translate_tts?ie=UTF-8&client=webapp`),e(this,"fallBacking",!1),e(this,"LAN_TO_CODE",new Map(f)),e(this,"CODE_TO_LAN",new Map(f.map((([t,e])=>[e,t])))),e(this,"AUDIO",new Audio),e(this,"cache",new g({max:200,ttl:12e4})),e(this,"inflightCount",0),e(this,"queue",[]),e(this,"tkMemo",new g({max:256,ttl:6e4}))}async _acquireSlot(){this.inflightCount<2||await new Promise((t=>this.queue.push(t))),this.inflightCount++}_releaseSlot(){this.inflightCount=Math.max(0,this.inflightCount-1);const t=this.queue.shift();t&&t()}generateTK(t,e,s){const n=`${e}.${s}.${p("string"==typeof t?t:String(t))}`,a=this.tkMemo.get(n);if(a)return a;e=Number(e)||0;let r=[],i=0,o=0;for(;o<t.length;o++){let e=t.charCodeAt(o);128>e?r[i++]=e:(2048>e?r[i++]=e>>6|192:(55296==(64512&e)&&o+1<t.length&&56320==(64512&t.charCodeAt(o+1))?(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++o)),r[i++]=e>>18|240,r[i++]=e>>12&63|128):r[i++]=e>>12|224,r[i++]=e>>6&63|128),r[i++]=63&e|128)}for(t=e,i=0;i<r.length;i++)t+=r[i],t=this._magic(t,"+-a^+6");t=this._magic(t,"+-3^+b+-f"),0>(t^=Number(s)||0)&&(t=2147483648+(2147483647&t));const c=(t%=1e6).toString()+"."+(t^e);return this.tkMemo.set(n,c),c}_magic(t,e){for(var s=0;s<e.length-2;s+=3){var n="a"<=(n=e.charAt(s+2))?n.charCodeAt(0)-87:Number(n);n="+"==e.charAt(s+1)?t>>>n:t<<n,t="+"==e.charAt(s)?t+n&4294967295:t^n}return t}async updateTKK(){let t=(await n.get(this.HOME_PAGE)).data,e=(t.match(/TKK=(.*?)\(\)\)'\);/i)||[""])[0].replace(/\\x([0-9A-Fa-f]{2})/g,"").match(/[+-]?\d+/g);e?(this.TKK[0]=Number(e[2]),this.TKK[1]=Number(e[0])+Number(e[1])):(e=t.match(/TKK[=:]['"](\d+?)\.(\d+?)['"]/i),e&&(this.TKK[0]=Number(e[1]),this.TKK[1]=Number(e[2])))}fallBack(){this.fallBacking=!0,setTimeout((()=>{this.fallBacking=!1}),18e5)}generateDetectURL(t){let e="&sl=auto&tl=zh-cn";return e+=`&tk=${this.generateTK(t,this.TKK[0],this.TKK[1])}&q=${encodeURIComponent(t)}`,this.fallBacking?this.FALLBACK_TRANSLATE_URL+e:this.TRANSLATE_URL+e}generateTranslateURL(t,e,s){let n=`&sl=${this.LAN_TO_CODE.get(e)}&tl=${this.LAN_TO_CODE.get(s)}`;return n+=`&tk=${this.generateTK(t,this.TKK[0],this.TKK[1])}&q=${encodeURIComponent(t)}`,this.fallBacking?this.FALLBACK_TRANSLATE_URL+n:this.TRANSLATE_URL+n}parseDetectResult(t){return this.fallBacking?this.CODE_TO_LAN.get(t[2])||"":t.ld_result.extended_srclangs?this.CODE_TO_LAN.get(t.ld_result.extended_srclangs[0])||"":this.CODE_TO_LAN.get(t.ld_result.srclangs[0])||""}parseBetterResult(t){const e={originalText:"",mainMeaning:""};if(t.sentences){e.mainMeaning="",e.originalText="";let s=0;for(;s<t.sentences.length&&t.sentences[s].trans;s++)e.mainMeaning+=t.sentences[s].trans,e.originalText+=t.sentences[s].orig;s<t.sentences.length&&(t.sentences[s].translit&&(e.tPronunciation=t.sentences[s].translit),t.sentences[s].src_translit&&(e.sPronunciation=t.sentences[s].src_translit))}if(t.dict){e.detailedMeanings=[];for(let s of t.dict)for(let t of s.entry)e.detailedMeanings.push({pos:s.pos,meaning:t.word,synonyms:t.reverse_translation})}if(t.definitions){e.definitions=[];for(let s of t.definitions)for(let t of s.entry)e.definitions.push({pos:s.pos,meaning:t.gloss,synonyms:[],example:t.example})}if(t.examples){e.examples=[];for(let s of t.examples.example)e.examples.push({source:s.text,target:null});e.examples.sort(((t,e)=>t.source>e.source?1:t.source===e.source?0:-1))}return e}parseFallbackResult(t){const e={originalText:"",mainMeaning:""};for(let s=0;s<t.length;s++)if(t[s]){const n=t[s];switch(s){case 0:{let t=[],s=[],a=n.length-1;for(let e=0;e<=a;e++)t.push(n[e][0]),s.push(n[e][1]);e.mainMeaning=t.join(""),e.originalText=s.join("");try{a>0&&(n[a][2]&&n[a][2].length>0&&(e.tPronunciation=n[a][2]),n[a][3]&&n[a][3].length>0&&(e.sPronunciation=n[a][3]))}catch{}break}case 1:e.detailedMeanings=new Array,n.forEach((t=>e.detailedMeanings.push({pos:t[0],meaning:t[1].join(", ")})));break;case 12:e.definitions=new Array,n.forEach((t=>{t[1].forEach((s=>{e.definitions.push({pos:t[0],meaning:s[0],example:s[2]})}))}));break;case 13:e.examples=new Array,n.forEach((t=>t.forEach((t=>e.examples.push({source:null,target:t[0]})))))}}return e}parseTranslateResult(t){return this.fallBacking?this.parseFallbackResult(t):this.parseBetterResult(t)}supportedLanguages(){return new Set(this.LAN_TO_CODE.keys())}detect(t){if(!t||!t.trim())return Promise.resolve("");const e=`Gd|${p(t)}`,s=this.cache.get(e);if(s)return Promise.resolve(s);const a=async()=>{await this._acquireSlot();let s=0;try{const r=await n.get(this.generateDetectURL(t),{validateStatus:t=>t<500,timeout:n.defaults.timeout||8e3});if(s=r.status,200===r.status){const t=this.parseDetectResult(r.data);return this.cache.set(e,t),t}if(429===r.status&&!this.fallBacking)return this.fallBack(),await this.updateTKK().then(a)}finally{this._releaseSlot()}throw{errorType:"API_ERR",errorCode:s,errorMsg:"Detect failed.",errorAct:{api:"google",action:"detect",text:t,from:null,to:null}}};return a()}translate(t,e,s){if(!t||!t.trim())return Promise.resolve({originalText:t||"",mainMeaning:""});const a=`Gt|${e}|${s}|${p(t)}`,r=this.cache.get(a);if(r)return Promise.resolve(r);const i=async()=>{await this._acquireSlot();let r=0;try{const o=await n.get(this.generateTranslateURL(t,e,s),{validateStatus:t=>t<500,timeout:n.defaults.timeout||8e3});if(r=o.status,200===o.status){let t=this.parseTranslateResult(o.data);return this.cache.set(a,t),t}if(429===o.status&&!this.fallBacking)return this.fallBack(),await this.updateTKK().then(i)}finally{this._releaseSlot()}throw{errorType:"API_ERR",errorCode:r,errorMsg:"Translate failed.",errorAct:{api:"google",action:"translate",text:t,from:e,to:s}}};return i()}async pronounce(t,e,s){this.stopPronounce();let n="fast"===s?"0.8":"0.2";this.AUDIO.src=`${this.fallBacking?this.FALLBACK_TTS_URL:this.TTS_URL}&q=${encodeURIComponent(t)}&tl=${this.LAN_TO_CODE.get(e)}&ttsspeed=${n}&tk=${this.generateTK(t,this.TKK[0],this.TKK[1])}`;try{await this.AUDIO.play()}catch(s){throw{errorType:"NET_ERR",errorCode:0,errorMsg:s.message,errorAct:{api:"google",action:"pronounce",text:t,from:e,to:null}}}}stopPronounce(){this.AUDIO.paused||this.AUDIO.pause()}}const _=[["auto","auto"],["bg","bg"],["et","et"],["pl","pl"],["da","da"],["de","de"],["ru","ru"],["fr","fr"],["fi","fi"],["nl","nl"],["zh-CN","zh"],["cs","cs"],["lv","lv"],["lt","lt"],["ro","ro"],["pt","pt"],["ja","ja"],["sv","sv"],["sk","sk"],["sl","sl"],["es","es"],["el","el"],["hu","hu"],["it","it"],["en","en"]];class y{constructor(t,s){e(this,"HOME_PAGE","https://www.deepl.com/translator"),e(this,"LAN_TO_CODE",new Map(_)),e(this,"CODE_TO_LAN",new Map(_.map((([t,e])=>[e,t])))),e(this,"langDetector"),e(this,"TTSEngine"),e(this,"deepLIframe"),this.langDetector=t,this.TTSEngine=s,this.createIframe()}createIframe(){this.deepLIframe=document.createElement("iframe"),document.body.appendChild(this.deepLIframe),this.deepLIframe.src=this.HOME_PAGE}supportedLanguages(){return new Set(this.LAN_TO_CODE.keys())}async detect(t){return await this.langDetector.detect(t)}async translate(t,e,s){try{return{mainMeaning:await new Promise(((n,a)=>{const r=setTimeout((()=>{a({status:408,errorMsg:"Request timeout!"})}),1e4),i=t=>{!t.data.type||"edge_translate_deepl_response"!==t.data.type||(window.removeEventListener("message",i),clearTimeout(r),200===t.data.status?n(t.data.result):a(t.data))};window.addEventListener("message",i),this.deepLIframe.contentWindow.postMessage({type:"edge_translate_deepl_request",url:`${this.HOME_PAGE}#${this.LAN_TO_CODE.get(e)}/${this.LAN_TO_CODE.get(s)}/${encodeURIComponent(t.replaceAll("/","\\/"))}`},this.HOME_PAGE)})),originalText:t}}catch(n){throw 408===n.status&&(document.body.removeChild(this.deepLIframe),this.createIframe()),n.errorCode=n.status||0,n.errorMsg=n.errorMsg||n.message,n.errorAct={api:"deepl",action:"translate",text:t,from:e,to:s},n}}async pronounce(t,e,s){return await this.TTSEngine.pronounce(t,e,s)}stopPronounce(){this.TTSEngine.stopPronounce()}}class R{constructor(t,s){e(this,"channel"),e(this,"CONFIG",{selections:{},translators:[]}),e(this,"REAL_TRANSLATORS"),e(this,"MAIN_TRANSLATOR","GoogleTranslate"),e(this,"cache",new g({max:200,ttl:3e5})),e(this,"inflight",new Map),this.channel=s,this.REAL_TRANSLATORS={BingTranslate:new m,GoogleTranslate:new T,DeepLTranslate:null},this.REAL_TRANSLATORS.DeepLTranslate=new y(this.REAL_TRANSLATORS.BingTranslate,this.REAL_TRANSLATORS.BingTranslate),this.useConfig(t),this.warmUpTranslators()}async warmUpTranslators(){setTimeout((()=>{this.REAL_TRANSLATORS.BingTranslate.warmUp().catch((()=>{}))}),100)}useConfig(t){t&&t.translators&&t.selections?(this.CONFIG=t,this.MAIN_TRANSLATOR=t.selections.mainMeaning):console.error("Invalid config for HybridTranslator!")}getAvailableTranslatorsFor(t,e){const s=[];for(const n of Object.keys(this.REAL_TRANSLATORS)){const a=this.REAL_TRANSLATORS[n].supportedLanguages();a.has(t)&&a.has(e)&&s.push(n)}return s.sort(((t,e)=>"GoogleTranslate"===t?-1:"GoogleTranslate"===e?1:t.localeCompare(e)))}updateConfigFor(t,e){const s={translators:[],selections:{}},n=new Set,a=this.getAvailableTranslatorsFor(t,e),r=a[0],i=new Set(a);let o;for(o in this.CONFIG.selections){let t,e=this.CONFIG.selections[o];i.has(e)?(s.selections[o]=e,t=e):(s.selections[o]=r,t=r),n.add(t)}return s.translators=Array.from(n),s}async detect(t){return this.REAL_TRANSLATORS[this.MAIN_TRANSLATOR].detect(t)}async translate(t,e,s){if(!t||!t.trim())return{originalText:t||"",mainMeaning:""};const n=`H|${e}|${s}|${p(t)}`,a=this.cache.get(n);if(a)return a;const r=this.inflight.get(n);if(r)return r;const i=(async()=>{let a=[];for(let n of this.CONFIG.translators)a.push(this.REAL_TRANSLATORS[n].translate(t,e,s).then((t=>[n,t])));const r={originalText:"",mainMeaning:""},i=new Map(await Promise.all(a));let o;for(o in this.CONFIG.selections)try{const t=this.CONFIG.selections[o];r[o]=i.get(t)[o]}catch(t){console.log(`${o} ${this.CONFIG.selections[o]}`),console.log(t)}return r.originalText||(r.originalText=t),this.cache.set(n,r),r})();this.inflight.set(n,i);try{return await i}finally{this.inflight.delete(n)}}async pronounce(t,e,s){return this.REAL_TRANSLATORS[this.MAIN_TRANSLATOR].pronounce(t,e,s)}async stopPronounce(){this.REAL_TRANSLATORS[this.MAIN_TRANSLATOR].stopPronounce()}getPerformanceStats(){var t;const e={cache:{size:this.cache.size(),inflight:this.inflight.size}};return null!=(t=this.REAL_TRANSLATORS.BingTranslate)&&t.getPoolStats&&(e.bing=this.REAL_TRANSLATORS.BingTranslate.getPoolStats()),e}async cleanup(){var t;this.cache.clear(),this.inflight.clear(),null!=(t=this.REAL_TRANSLATORS.BingTranslate)&&t.cleanup&&await this.REAL_TRANSLATORS.BingTranslate.cleanup()}}const b=["Unable to download","Unable to download all specified images","Cannot access","before initialization","Extension context invalidated","Canvas error","Network error"];const S={debug:10,info:20,warn:30,error:40,silent:90};function A(t){return S[t]>=S.warn}function E(...t){A("info")&&console.log("[EdgeTranslate]",...t)}function w(...t){A("warn")&&console.warn("[EdgeTranslate]",...t)}class O{static create(t){return new Promise(((e,s)=>{chrome.tabs.create(t,(t=>{if(chrome.runtime.lastError)return s(chrome.runtime.lastError.message);e(t)}))}))}static query(t){return new Promise(((e,s)=>{chrome.tabs.query(t,(t=>chrome.runtime.lastError||!t[0]||t[0].id<0?s({error:chrome.runtime.lastError||"The query has no results"}):e(t)))}))}}const C={ach:"ach",ady:"en",af:"af","af-NA":"af","af-ZA":"af",ak:"aka",am:"am",ar:"ar","ar-AR":"ar","ar-MA":"ar","ar-SA":"ar","ay-BO":"aym",az:"az","az-AZ":"az","be-BY":"be",bg:"bg","bg-BG":"bg",bn:"bn","bn-IN":"bn","bn-BD":"bn","bs-BA":"bs",ca:"ca","ca-ES":"ca",cak:"en",ceb:"ceb","ck-US":"chr",co:"co",cs:"cs","cs-CZ":"cs",cy:"cy","cy-GB":"cy",da:"da","da-DK":"da",de:"de","de-AT":"de","de-DE":"de","de-CH":"de",dsb:"en",el:"el","el-GR":"el",en:"en","en-GB":"en","en-AU":"en","en-CA":"en","en-IE":"en","en-IN":"en","en-PI":"en","en-UD":"en","en-US":"en","en-ZA":"en","en@pirate":"en",eo:"eo","eo-EO":"eo",es:"es","es-AR":"es","es-419":"es","es-CL":"es","es-CO":"es","es-EC":"es","es-ES":"es","es-LA":"es","es-NI":"es","es-MX":"es","es-US":"es","es-VE":"es",et:"et","et-EE":"et",eu:"eu","eu-ES":"eu",fa:"fa","fa-IR":"fa","fb-LT":"en",ff:"en",fi:"fi","fi-FI":"fi","fo-FO":"fao",fr:"fr","fr-CA":"fr","fr-FR":"fr","fr-BE":"fr","fr-CH":"fr","fy-NL":"fy",ga:"ga","ga-IE":"ga",gd:"gd",gl:"gl","gl-ES":"gl","gn-PY":"grn","gu-IN":"gu","gx-GR":"el",ha:"ha",haw:"haw",he:"he","he-IL":"he",hi:"hi","hi-IN":"hi",hmn:"hmn",hr:"hr","hr-HR":"hr",hsb:"en",ht:"ht",hu:"hu","hu-HU":"hu","hy-AM":"hy",id:"id","id-ID":"id",ig:"ig",is:"is","is-IS":"is",it:"it","it-IT":"it",iw:"he",ja:"ja","ja-JP":"ja","jv-ID":"jw","ka-GE":"ka","kk-KZ":"kk",km:"km","km-KH":"km",kab:"kab",kn:"kn","kn-IN":"kn",ko:"ko","ko-KR":"ko","ku-TR":"ku",ky:"ky",la:"la","la-VA":"la",lb:"lb","li-NL":"lim",lo:"lo",lt:"lt","lt-LT":"lt",lv:"lv","lv-LV":"lv",mai:"mai","mg-MG":"mg",mi:"mi",mk:"mk","mk-MK":"mk",ml:"ml","ml-IN":"ml","mn-MN":"mn",mr:"mr","mr-IN":"mr",ms:"ms","ms-MY":"ms",mt:"mt","mt-MT":"mt",my:"my",no:"no",nb:"no","nb-NO":"no",ne:"ne","ne-NP":"ne",nl:"nl","nl-BE":"nl","nl-NL":"nl","nn-NO":"no",ny:"ny",oc:"oci","or-IN":"or",pa:"pa","pa-IN":"pa",pl:"pl","pl-PL":"pl","ps-AF":"ps",pt:"pt","pt-BR":"pt","pt-PT":"pt","qu-PE":"que","rm-CH":"roh",ro:"ro","ro-RO":"ro",ru:"ru","ru-RU":"ru","sa-IN":"san",sd:"sd","se-NO":"sme","si-LK":"si",sk:"sk","sk-SK":"sk",sl:"sl","sl-SI":"sl",sm:"sm",sn:"sn","so-SO":"so",sq:"sq","sq-AL":"sq",sr:"sr","sr-RS":"sr",st:"st",su:"su",sv:"sv","sv-SE":"sv",sw:"sw","sw-KE":"sw",ta:"ta","ta-IN":"ta",te:"te","te-IN":"te",tg:"tg","tg-TJ":"tg",th:"th","th-TH":"th",tl:"fil","tl-PH":"fil",tlh:"tlh",tr:"tr","tr-TR":"tr","tt-RU":"tat",uk:"uk","uk-UA":"uk",ur:"ur","ur-PK":"ur",uz:"uz","uz-UZ":"uz",vi:"vi","vi-VN":"vi","xh-ZA":"xh",yi:"yi","yi-DE":"yi",yo:"yo",zh:"zh-CN","zh-Hans":"zh-CN","zh-Hant":"zh-TW","zh-CN":"zh-CN","zh-HK":"zh-TW","zh-SG":"zh-CN","zh-TW":"zh-TW","zu-ZA":"zu"},v={blacklist:{urls:{},domains:{"chrome.google.com":!0,extensions:!0}},LayoutSettings:{Resize:!1,RTL:!1,FoldLongContent:!0,SelectTranslatePosition:"TopRight"},languageSetting:{sl:"auto",tl:C[chrome.i18n.getUILanguage()]},OtherSettings:{MutualTranslate:!1,SelectTranslate:!0,TranslateAfterDblClick:!1,TranslateAfterSelect:!1,CancelTextSelection:!1,UseGoogleAnalytics:!1},DefaultTranslator:"GoogleTranslate",DefaultPageTranslator:"GooglePageTranslate",HybridTranslatorConfig:{translators:["BingTranslate","GoogleTranslate"],selections:{originalText:"GoogleTranslate",mainMeaning:"GoogleTranslate",tPronunciation:"GoogleTranslate",sPronunciation:"GoogleTranslate",detailedMeanings:"BingTranslate",definitions:"GoogleTranslate",examples:"GoogleTranslate"}},TranslateResultFilter:{mainMeaning:!0,originalText:!0,tPronunciation:!0,sPronunciation:!0,tPronunciationIcon:!0,sPronunciationIcon:!0,detailedMeanings:!0,definitions:!0,examples:!0},ContentDisplayOrder:["mainMeaning","originalText","detailedMeanings","definitions","examples"],HidePageTranslatorBanner:!1};function L(t,e){for(let s in e)"object"==typeof e[s]&&!(e[s]instanceof Array)&&Object.keys(e[s]).length>0?t[s]?L(t[s],e[s]):t[s]=e[s]:void 0===t[s]&&(t[s]=e[s])}function k(t,e){return new Promise((s=>{if("string"==typeof t)t=[t];else if(void 0===t){t=[];for(let s in e)t.push(s)}chrome.storage.sync.get(t,(n=>{let a=!1;for(let s of t)n[s]||("function"==typeof e&&(e=e(t)),n[s]=e[s],a=!0);a?chrome.storage.sync.set(n,(()=>s(n))):s(n)}))}))}function N(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,n)}return s}function I(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?N(Object(s),!0).forEach((function(e){P(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):N(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function P(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function x(t){k(["DefaultPageTranslator","languageSetting"],v).then((t=>{t.DefaultPageTranslator}))}function M(t){if(t){let e=/.+:\/+([\w.-]+).*/,s=t.match(e);if(s)return s[1]}return""}function D(t){E(t)}const H="X";function U(t,e){chrome.tabs.query({active:!0,currentWindow:!0},(s=>{s&&s[0]&&k("blacklist",v).then((n=>{let a=n.blacklist,r="urls"===t?s[0].url:M(s[0].url);a[t][r]=!0,chrome.storage.sync.set({blacklist:a},(()=>{e(a,s[0].url)}))}))}))}function q(t,e){chrome.tabs.query({active:!0,currentWindow:!0},(s=>{s&&s[0]&&k("blacklist",v).then((n=>{let a=n.blacklist,r="urls"===t?s[0].url:M(s[0].url);a[t][r]&&delete a[t][r],chrome.storage.sync.set({blacklist:a},(()=>{e(a,s[0].url)}))}))}))}function z(t){k("blacklist",v).then((e=>{e.blacklist.domains[M(t)]?(F(["add_url_blacklist","remove_url_blacklist","add_domain_blacklist"]),$(["remove_domain_blacklist"]),chrome.action.setBadgeText({text:H})):e.blacklist.urls[t]?(F(["add_url_blacklist","add_domain_blacklist","remove_domain_blacklist"]),$(["remove_url_blacklist"]),chrome.action.setBadgeText({text:H})):(F(["remove_url_blacklist","remove_domain_blacklist"]),$(["add_url_blacklist","add_domain_blacklist"]),chrome.action.setBadgeText({text:""}))}))}function $(t){t.forEach((t=>{chrome.contextMenus.update(t,{enabled:!0,visible:!0},(()=>{chrome.runtime.lastError&&D(`Chrome runtime error: ${chrome.runtime.lastError}`)}))}))}function F(t){t.forEach((t=>{chrome.contextMenus.update(t,{enabled:!1,visible:!1},(()=>{chrome.runtime.lastError&&D(`Chrome runtime error: ${chrome.runtime.lastError}`)}))}))}var G;const B=["Unable to download","Unable to download all specified images","Image loading failed","Cannot access","before initialization","Extension context invalidated","Canvas error","Network error"];function j(t){return B.some((e=>t.includes(e)||/Cannot access '.*' before initialization/.test(t)||/ReferenceError.*before initialization/.test(t)||/Unable to download.*images/.test(t)))}!function(){const t=console.error;console.error=function(...e){(function(t){if(!t)return!1;try{return b.some((e=>t.includes(e)))||/Cannot access '.*' before initialization/.test(t)||/ReferenceError.*before initialization/.test(t)||/Unable to download.*images/.test(t)}catch(t){return!1}})(function(t){try{return t.map((t=>"string"==typeof t?t:t&&t.message||JSON.stringify(t))).join(" ")}catch(e){return t.join(" ")}}(e))||t.apply(console,e)}}();try{var K,Y;null===(K=chrome.runtime.onStartup)||void 0===K||null===(Y=K.addListener)||void 0===Y||Y.call(K,(()=>{E("Extension startup")}))}catch(t){}const W=new Map;try{chrome.webRequest.onHeadersReceived.addListener((t=>{var e;if(0!==t.frameId)return;const s=t.url,n=t.responseHeaders||[],a=n.find((t=>"content-type"===t.name.toLowerCase())),r=(null==a||null===(e=a.value)||void 0===e?void 0:e.toLowerCase())||"",i=function(t){const e=t.toLowerCase();return e.includes("application/pdf")||e.includes("application/x-pdf")||e.includes("text/pdf")||e.includes("application/octet-stream")&&e.includes("pdf")}(r),o=function(t){var e,s;return((null===(e=t.find((t=>"content-disposition"===t.name.toLowerCase())))||void 0===e||null===(s=e.value)||void 0===s?void 0:s.toLowerCase())||"").includes("attachment")}(n);W.set(s,{isPdf:i,isDownload:o,contentType:r}),i&&!o?setTimeout((async()=>{try{const e=chrome.runtime.getURL(`web/viewer.html?file=${encodeURIComponent(s)}&source=${encodeURIComponent(s)}`);await chrome.tabs.update(t.tabId,{url:e}),E(`PDF redirected: ${s} (Content-Type: ${r})`)}catch(t){w("PDF redirect failed",t)}}),10):i&&o&&E(`PDF download request ignored: ${s}`)}),{urls:["<all_urls>"],types:["main_frame"]},["responseHeaders"])}catch(t){w("webRequest unavailable, falling back to URL-based detection",t)}try{chrome.webNavigation.onCommitted.addListener((async t=>{if(0!==t.frameId||!t.url)return;const e=t.url;if(!/^https?:|^file:|^ftp:/i.test(e))return;const s=W.get(e);if(s){if(setTimeout((()=>W.delete(e)),5e3),!1===s.isPdf)return;if(s.isDownload)return}const n=function(t){var e,s;if(/\.pdf($|[?#])/i.test(t))return!0;if(/\/pdf\/[^/]+/i.test(t))return!0;if(/[?&][^=]*\.pdf/i.test(t))return!0;if(/\/download[^/]*pdf/i.test(t))return!0;if(/\/view[^/]*pdf/i.test(t))return!0;if(/\/(papers?|documents?|files?|articles?|publications?)\//i.test(t)){const e=t.match(/\/(papers?|documents?|files?|articles?|publications?)\/([^/?#]+)/i);if(e){const t=e[2];if(/[\d_.-]/i.test(t)&&!/^(info|list|about|help|index|home)$/i.test(t))return!0}}const n=(null===(e=t.match(/\/\/([^/]+)/))||void 0===e||null===(s=e[1])||void 0===s?void 0:s.toLowerCase())||"";return!!(n.includes("arxiv")&&/\/pdf\//i.test(t)||n.includes("researchgate")&&(/\.pdf/i.test(t)||/\/pdf/i.test(t))||n.includes("ieee")&&/\/pdf/i.test(t)||n.includes("acm")&&/\/pdf/i.test(t)||n.includes("springer")&&(/\.pdf/i.test(t)||/\/pdf/i.test(t))||n.includes("sciencedirect")&&/\/pdf/i.test(t)||n.includes("jstor")&&/\.pdf/i.test(t))}(e);if(!n)return;const a=chrome.runtime.getURL(`web/viewer.html?file=${encodeURIComponent(e)}&source=${encodeURIComponent(e)}`);try{await chrome.tabs.update(t.tabId,{url:a}),E(`PDF redirected via URL pattern: ${e}`)}catch(t){w("PDF redirect failed",t)}}))}catch(t){w("webNavigation unavailable",t)}"undefined"!=typeof window&&(window.addEventListener("error",(t=>{if(t.error&&t.error.message&&j(t.error.message))return t.preventDefault(),!1})),window.addEventListener("unhandledrejection",(t=>{if(t.reason){const e="string"==typeof t.reason?t.reason:t.reason.message||t.reason.toString()||"";if(j(e))return w(" Promise rejection:",e),t.preventDefault(),!1}})));class X{constructor(t="div"){this.tagName=t.toUpperCase(),this.nodeName=t.toUpperCase(),this.nodeType=1,this.children=[],this.childNodes=[],this.attributes=new Map,this.textContent="",this.innerHTML="",this.outerHTML="",this.className="",this.id="",this.parentNode=null,this.style={}}setAttribute(t,e){this.attributes.set(t,e)}getAttribute(t){return this.attributes.get(t)||null}removeAttribute(t){this.attributes.delete(t)}appendChild(t){return t&&"object"==typeof t&&(this.children.push(t),this.childNodes.push(t),t.parentNode=this),t}removeChild(t){const e=this.children.indexOf(t);return e>-1&&(this.children.splice(e,1),this.childNodes.splice(e,1),t.parentNode=null),t}addEventListener(){}removeEventListener(){}dispatchEvent(){}click(){}focus(){}blur(){}}function Q(t="div"){const e=new X(t);return e.querySelector=()=>null,e.querySelectorAll=()=>[],e.getElementsByTagName=()=>[],e.getElementsByClassName=()=>[],e.getElementById=()=>null,e.style=new Proxy({},{get:()=>"",set:()=>!0}),e._src="",Object.defineProperty(e,"src",{get(){return this._src||""},set(t){this._src=t,"IMG"!==this.tagName&&"IFRAME"!==this.tagName||setTimeout((()=>{this.onload&&this.onload({type:"load",target:this})}),10)}}),e._href="",Object.defineProperty(e,"href",{get(){return this._href||""},set(t){this._href=t}}),"document"===t.toLowerCase()&&(e.location={origin:"chrome-extension://",pathname:"/background.js",search:"",href:"chrome-extension://background.js"}),e}if(self.MockElement=X,"undefined"==typeof Audio&&(self.Audio=class{constructor(t){this.src=t||"",this.currentTime=0,this.duration=0,this.paused=!0,this.ended=!1,this.volume=1,this.muted=!1}play(){return this.paused=!1,Promise.resolve()}pause(){this.paused=!0}load(){}addEventListener(){}removeEventListener(){}}),"undefined"==typeof Image&&(self.Image=class extends EventTarget{constructor(t,e){super(),this.width=t||0,this.height=e||0,this.complete=!0,this.naturalWidth=t||100,this.naturalHeight=e||100,this._src="",this._onload=null,this._onerror=null,this.crossOrigin=null,this.loading="auto",this.referrerPolicy="",this.decode=()=>Promise.resolve()}set src(t){this._src=t,this.complete=!1,setTimeout((()=>{this.complete=!0,this.naturalWidth=this.width||100,this.naturalHeight=this.height||100;const t=new Event("load");this.dispatchEvent(t),this._onload&&this._onload(t),this.onload&&this.onload(t)}),1)}get src(){return this._src}set onload(t){this._onload=t}get onload(){return this._onload}set onerror(t){this._onerror=t}get onerror(){return this._onerror}addEventListener(t,e){super.addEventListener(t,e)}removeEventListener(t,e){super.removeEventListener(t,e)}}),"undefined"==typeof DOMParser&&(self.DOMParser=class{parseFromString(t,e="text/html"){const s=Q("document");if(s.documentElement=Q("html"),s.head=Q("head"),s.body=Q("body"),s.documentElement.appendChild(s.head),s.documentElement.appendChild(s.body),s.appendChild(s.documentElement),"text/html"===e&&t.includes("rich_tta")){const t=Q("div");t.id="rich_tta",t.setAttribute("data-iid","mock-iid-value"),s.body.appendChild(t)}return s.getElementById=function(t){return function t(e,s){if(e.id===s)return e;if(e.children)for(let n of e.children){const e=t(n,s);if(e)return e}return null}(this,t)},s.querySelector=self.document.querySelector,s.querySelectorAll=self.document.querySelectorAll,s.createElement=self.document.createElement,s.createTextNode=self.document.createTextNode,s}}),"undefined"==typeof document&&(self.document=Q("document"),self.document.documentElement=Q("html"),self.document.head=Q("head"),self.document.body=Q("body"),self.document.documentElement.appendChild(self.document.head),self.document.documentElement.appendChild(self.document.body),self.document.appendChild(self.document.documentElement),self.document.createElement=function(t){return Q(t)},self.document.createTextNode=function(t){return{nodeType:3,nodeName:"#text",textContent:t,data:t,parentNode:null}},self.document.getElementById=function(t){return function t(e,s){if(e.id===s)return e;if(e.children)for(let n of e.children){const e=t(n,s);if(e)return e}return null}(self.document,t)},self.document.querySelector=function(t){return t.startsWith("#")?self.document.getElementById(t.slice(1)):null},self.document.querySelectorAll=function(){return[]}),"undefined"==typeof location&&(self.location={origin:"chrome-extension://",pathname:"/background.js",search:"",href:"chrome-extension://background.js",protocol:"chrome-extension:",host:"",hostname:""}),"function"==typeof importScripts&&"undefined"==typeof window){const t=Object.defineProperty;Object.defineProperty=function(...e){return"axios"===e[1]&&e[0]===self?t.call(this,...e):t.apply(this,e)},console.log("[EdgeTranslate] Service Worker    - translators   ")}"undefined"==typeof XMLHttpRequest&&(self.XMLHttpRequest=class extends EventTarget{constructor(){super(),this.readyState=0,this.status=0,this.statusText="",this.responseText="",this.response="",this.responseType="",this.timeout=0,this.withCredentials=!1,this.onreadystatechange=null,this.onload=null,this.onerror=null,this.onabort=null,this.ontimeout=null,this._method="",this._url="",this._async=!0,this._requestHeaders={},this._aborted=!1}static get UNSENT(){return 0}static get OPENED(){return 1}static get HEADERS_RECEIVED(){return 2}static get LOADING(){return 3}static get DONE(){return 4}get UNSENT(){return 0}get OPENED(){return 1}get HEADERS_RECEIVED(){return 2}get LOADING(){return 3}get DONE(){return 4}open(t,e,s=!0){this._method=t.toUpperCase(),this._url=e,this._async=s,this.readyState=1,this._fireReadyStateChange()}setRequestHeader(t,e){if(1!==this.readyState)throw new Error("InvalidStateError");this._requestHeaders[t]=e}send(t=null){if(1!==this.readyState)throw new Error("InvalidStateError");if(this._aborted)return;const e={method:this._method,headers:this._requestHeaders};t&&"GET"!==this._method&&"HEAD"!==this._method&&(e.body=t);const s=new AbortController;e.signal=s.signal,this.timeout>0&&setTimeout((()=>{this._aborted||4===this.readyState||(s.abort(),this._handleTimeout())}),this.timeout),this.readyState=2,this._fireReadyStateChange(),fetch(this._url,e).then((t=>{if(!this._aborted)return this.status=t.status,this.statusText=t.statusText,this.readyState=3,this._fireReadyStateChange(),t.text()})).then((t=>{this._aborted||(this.responseText=t||"",this.response="json"===this.responseType?this._tryParseJSON(t):t,this.readyState=4,this._fireReadyStateChange(),this.onload&&this.onload(new Event("load")))})).catch((t=>{this._aborted||("AbortError"===t.name?this._handleTimeout():(this.status=0,this.statusText="",this.readyState=4,this._fireReadyStateChange(),this.onerror&&this.onerror(new Event("error"))))}))}abort(){this._aborted=!0,this.readyState=4,this._fireReadyStateChange(),this.onabort&&this.onabort(new Event("abort"))}getResponseHeader(){return null}getAllResponseHeaders(){return""}_fireReadyStateChange(){this.onreadystatechange&&this.onreadystatechange(new Event("readystatechange")),this.dispatchEvent(new Event("readystatechange"))}_handleTimeout(){this.status=0,this.statusText="",this.readyState=4,this._fireReadyStateChange(),this.ontimeout&&this.ontimeout(new Event("timeout"))}_tryParseJSON(t){try{return JSON.parse(t)}catch(e){return t}}}),"undefined"==typeof console&&(self.console={log:()=>{},warn:()=>{},error:()=>{},info:()=>{},debug:()=>{},trace:()=>{}}),"undefined"==typeof navigator&&(self.navigator={language:"en-US",languages:["en-US","en"],userAgent:"Mozilla/5.0 (ServiceWorker)",platform:"chrome-extension"}),"undefined"==typeof URL||URL.createObjectURL||(URL.createObjectURL=function(){return`blob:chrome-extension://mock-${Math.random().toString(36).substr(2,9)}`},URL.revokeObjectURL=function(){});let V=!1;function J(){if(V)return;const t=()=>{chrome.contextMenus.create({id:"translate",title:`${chrome.i18n.getMessage("Translate")} '%s'`,contexts:["selection"]}),chrome.contextMenus.create({id:"shortcut",title:chrome.i18n.getMessage("ShortcutSetting"),contexts:["action"]}),chrome.contextMenus.create({id:"add_url_blacklist",title:chrome.i18n.getMessage("AddUrlBlacklist"),contexts:["action"],enabled:!1,visible:!1}),chrome.contextMenus.create({id:"add_domain_blacklist",title:chrome.i18n.getMessage("AddDomainBlacklist"),contexts:["action"],enabled:!1,visible:!1}),chrome.contextMenus.create({id:"remove_url_blacklist",title:chrome.i18n.getMessage("RemoveUrlBlacklist"),contexts:["action"],enabled:!1,visible:!1}),chrome.contextMenus.create({id:"remove_domain_blacklist",title:chrome.i18n.getMessage("RemoveDomainBlacklist"),contexts:["action"],enabled:!1,visible:!1}),V=!0};try{chrome.contextMenus.removeAll((()=>{chrome.runtime.lastError,t()}))}catch(e){t()}}chrome.runtime.onInstalled.addListener((async t=>{J(),"install"===t.reason?(chrome.tabs.create({url:chrome.i18n.getMessage("WikiLink")}),chrome.notifications&&"function"==typeof chrome.notifications.create&&chrome.notifications.create("data_collection_notification",{type:"basic",iconUrl:chrome.runtime.getURL("icon/icon128.png"),title:chrome.i18n.getMessage("AppName"),message:chrome.i18n.getMessage("DataCollectionNotice")})):"update"===t.reason&&(await new Promise((t=>{chrome.storage.sync.get((e=>{let s=e;L(s,v),chrome.storage.sync.set(s,t)}))})),chrome.storage.sync.get("languageSetting",(t=>{t.languageSetting&&("zh-cn"===t.languageSetting.sl?t.languageSetting.sl="zh-CN":"zh-tw"===t.languageSetting.sl&&(t.languageSetting.sl="zh-TW"),"zh-cn"===t.languageSetting.tl?t.languageSetting.tl="zh-CN":"zh-tw"===t.languageSetting.tl&&(t.languageSetting.tl="zh-TW"),chrome.storage.sync.set(t))})),chrome.notifications&&"function"==typeof chrome.notifications.create&&chrome.notifications.create("update_notification",{type:"basic",iconUrl:chrome.runtime.getURL("icon/icon128.png"),title:chrome.i18n.getMessage("AppName"),message:chrome.i18n.getMessage("ExtensionUpdated")}))})),chrome.runtime.onStartup.addListener((()=>{J()}));const Z=new class{constructor(){this._services=new Map,this._eventManager=new class{constructor(){this._handlerID=1,this._eventToHandlerIDs=new Map,this._handlerIDToHandler=new Map}on(t,e){const s=this._allocHandlerID();this._handlerIDToHandler.set(s,e),this._eventToHandlerIDs.has(t)?this._eventToHandlerIDs.get(t).add(s):this._eventToHandlerIDs.set(t,new Set([s]));let n=!1;return(()=>{n?console.warn("You shouldn't call the canceler more than once!"):(n=!0,this._off(t,s))}).bind(this)}emit(t,e,s){const n=this._eventToHandlerIDs.get(t);if(n)for(const t of n){const n=this._handlerIDToHandler.get(t);n&&n(e,s)}}_allocHandlerID(){for(;this._handlerIDToHandler.has(this._handlerID);)this._handlerID=(this._handlerID+1)%Number.MAX_SAFE_INTEGER;return this._handlerID}_off(t,e){const s=this._eventToHandlerIDs.get(t);s&&s.delete(e),this._handlerIDToHandler.delete(e)}},chrome.runtime.onMessage.addListener(((t,e,s)=>{let n=JSON.parse(t);if(n&&n.type)switch(n.type){case"event":this._eventManager.emit(n.event,n.detail,e),s&&s();break;case"service":{const t=this._services.get(n.service);if(!t)break;return t(n.params,e).then((t=>s&&s(t))),!0}default:console.error(`Unknown message type: ${t.type}`)}else console.error(`Bad message: ${t}`)}).bind(this))}provide(t,e){this._services.set(t,e)}request(t,e){const s=JSON.stringify({type:"service",service:t,params:e});return new Promise(((t,e)=>{chrome.runtime.sendMessage(s,(s=>{chrome.runtime.lastError?e(chrome.runtime.lastError):t(s)}))}))}requestToTab(t,e,s){const n=this._getTabMessageSender();return n?n(t,JSON.stringify({type:"service",service:e,params:s})):Promise.reject("Can not send message to tabs in current context!")}on(t,e){return this._eventManager.on(t,e)}emit(t,e){let s=JSON.stringify({type:"event",event:t,detail:e});chrome.runtime.sendMessage(s,(()=>{chrome.runtime.lastError&&console.error(chrome.runtime.lastError)}))}emitToTabs(t,e,s){const n=this._getTabMessageSender();if(!n)return void console.error("Can not send message to tabs in current context!");"number"==typeof t&&(t=[t]);const a=JSON.stringify({type:"event",event:e,detail:s});for(let e of t)n(e,a).catch((t=>console.error(t)))}_getTabMessageSender(){return chrome.tabs&&chrome.tabs.sendMessage?(t,e)=>new Promise(((s,n)=>{chrome.tabs.sendMessage(t,e,(t=>{chrome.runtime.lastError?n(chrome.runtime.lastError):s(t)}))})):null}},tt=new class{constructor(t){this.channel=t,this.config_loader=k(["HybridTranslatorConfig","DefaultTranslator","languageSetting","OtherSettings"],v).then((e=>{this.HYBRID_TRANSLATOR=new R(e.HybridTranslatorConfig,t),this.TRANSLATORS=I({HybridTranslate:this.HYBRID_TRANSLATOR},this.HYBRID_TRANSLATOR.REAL_TRANSLATORS),this.IN_MUTUAL_MODE=e.OtherSettings.MutualTranslate||!1,this.LANGUAGE_SETTING=e.languageSetting,this.DEFAULT_TRANSLATOR=e.DefaultTranslator,setTimeout((()=>{try{this.warmUpTranslators()}catch(t){}}),0)})),this.TTS_SPEED="fast",this.cacheOptions={maxEntries:300,detectTtlMs:6e5,translateTtlMs:18e5,maxKeyTextLength:500,debounceWindowMs:250},this.detectCache=new Map,this.translationCache=new Map,this.inflightDetect=new Map,this.inflightTranslate=new Map,this.lastTranslateKey=null,this.lastTranslateAt=0,this.provideServices(),this.listenToEvents()}clearCaches(){this.detectCache.clear(),this.translationCache.clear()}fnv1aHash32(t){try{let e=2166136261;for(let s=0;s<t.length;s++)e^=t.charCodeAt(s),e=e+((e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24))>>>0;return e.toString(16).padStart(8,"0")}catch(t){return"00000000"}}normalizeKeyText(t){if("string"!=typeof t)return"";const e=t.trim().replace(/\s+/g," "),s=this.cacheOptions.maxKeyTextLength;return e.length<=s?e:`${e.slice(0,Math.max(24,Math.floor(s/2)))}__${this.fnv1aHash32(e)}`}makeDetectKey(t){return this.normalizeKeyText(t)}makeTranslateKey(t,e,s,n){return`${n}||${e}||${s}||${this.normalizeKeyText(t)}`}getFromCache(t,e){const s=t.get(e);if(!s)return null;const n=Date.now();return s.expireAt&&s.expireAt<=n?(t.delete(e),null):(t.delete(e),t.set(e,s),s.value)}setCacheEntry(t,e,s,n){try{const a=n?Date.now()+n:0;t.has(e)&&t.delete(e),t.set(e,{value:s,expireAt:a});const r=this.cacheOptions.maxEntries;if(t.size>r){const e=t.keys().next().value;void 0!==e&&t.delete(e)}}catch(t){}}getDetectionFromCache(t){const e=this.makeDetectKey(t);return this.getFromCache(this.detectCache,e)}rememberDetection(t,e){if(!t||!e)return;const s=this.makeDetectKey(t);this.setCacheEntry(this.detectCache,s,e,this.cacheOptions.detectTtlMs)}getTranslationFromCache(t,e,s,n){const a=this.makeTranslateKey(t,e,s,n);return this.getFromCache(this.translationCache,a)}rememberTranslation(t,e,s,n,a){const r=this.makeTranslateKey(t,e,s,n);this.setCacheEntry(this.translationCache,r,a,this.cacheOptions.translateTtlMs)}provideServices(){this.channel.provide("translate",(t=>this.translate(t.text,t.position))),this.channel.provide("translate_text_quiet",(async t=>{await this.config_loader;const e=t&&t.text?t.text:"";if(!e)return Promise.resolve({originalText:"",translatedText:""});let s=t&&t.sl||this.LANGUAGE_SETTING.sl||"auto",n=t&&t.tl||this.LANGUAGE_SETTING.tl;try{const t=this.DEFAULT_TRANSLATOR;let a=this.getTranslationFromCache(e,s,n,t);return a||(a=await this.TRANSLATORS[t].translate(e,s,n),a&&this.rememberTranslation(e,s,n,t,a)),Promise.resolve(a||{originalText:e,translatedText:e})}catch(t){return Promise.resolve({originalText:e,translatedText:e})}})),this.channel.provide("pronounce",(t=>{let e=t.speed;return e||(e=this.TTS_SPEED,this.TTS_SPEED="fast"===e?"slow":"fast"),this.pronounce(t.pronouncing,t.text,t.language,e)})),this.channel.provide("get_available_translators",(t=>Promise.resolve(this.getAvailableTranslators(t)))),this.channel.provide("update_default_translator",(t=>this.updateDefaultTranslator(t.translator))),this.channel.provide("tts_finished",(async t=>{const e=await this.getCurrentTabId();return-1!==e&&this.channel.emitToTabs(e,"pronouncing_finished",t),Promise.resolve()})),this.channel.provide("tts_error",(async t=>{const e=await this.getCurrentTabId();return-1!==e&&this.channel.emitToTabs(e,"pronouncing_error",t),Promise.resolve()}))}async warmUpTranslators(){try{await this.config_loader;const t=new Set;this.DEFAULT_TRANSLATOR&&t.add(this.DEFAULT_TRANSLATOR),this.HYBRID_TRANSLATOR&&this.HYBRID_TRANSLATOR.REAL_TRANSLATORS&&Object.keys(this.HYBRID_TRANSLATOR.REAL_TRANSLATORS).forEach((e=>t.add(e)));const e="a",s=[];for(const n of t){const t=this.TRANSLATORS[n];t&&("function"!=typeof t.updateTokens?"function"!=typeof t.updateTKK?"function"==typeof t.detect&&s.push(Promise.resolve().then((()=>t.detect(e))).catch((()=>{}))):s.push(Promise.resolve().then((()=>t.updateTKK())).catch((()=>{}))):s.push(Promise.resolve().then((()=>t.updateTokens())).catch((()=>{}))))}const n=(t,e)=>Promise.race([t,new Promise((t=>setTimeout(t,e)))]);await n(Promise.allSettled(s),2500)}catch(t){}}listenToEvents(){this.channel.on("translate_page_google",(()=>{})),this.channel.on("language_setting_update",this.onLanguageSettingUpdated.bind(this)),this.channel.on("frame_closed",this.stopPronounce.bind(this)),chrome.storage.onChanged.addListener((async(t,e)=>{"sync"===e&&(await this.config_loader,t.HybridTranslatorConfig&&(this.HYBRID_TRANSLATOR.useConfig(t.HybridTranslatorConfig.newValue),this.clearCaches()),t.OtherSettings&&(this.IN_MUTUAL_MODE=t.OtherSettings.newValue.MutualTranslate),t.languageSetting&&(this.LANGUAGE_SETTING=t.languageSetting.newValue,this.clearCaches()),t.DefaultTranslator&&(this.DEFAULT_TRANSLATOR=t.DefaultTranslator.newValue,this.clearCaches(),this.inflightDetect.clear(),this.inflightTranslate.clear()))}).bind(this))}async getCurrentTabId(){let t=-1;const e=await O.query({active:!0,currentWindow:!0});return t=e[0].id,await this.channel.requestToTab(t,"check_availability").catch((async()=>{if(!await new Promise((t=>{/^file:\/\.*/.test(e[0].url)&&confirm(chrome.i18n.getMessage("PermissionRemind"))?(chrome.tabs.create({url:`chrome://extensions/?id=${chrome.runtime.id}`}),t(!1)):t(!0)})))return void(t=-1);const s=chrome.runtime.getURL("content/notice/notice.html");try{const e=(await O.query({url:s}))[0];chrome.tabs.highlight({tabs:e.index}),t=e.id}catch(e){const a=await O.create({url:s,active:!0});await(n=200,new Promise(((t,e)=>{setTimeout((()=>{t()}),n)}))),t=a.id}var n})),t}async detect(t){if(await this.config_loader,!t)return"";const e=this.getDetectionFromCache(t);if(e)return e;const s=this.makeDetectKey(t);if(this.inflightDetect.has(s))return this.inflightDetect.get(s);const n=this.TRANSLATORS[this.DEFAULT_TRANSLATOR].detect(t).then((e=>(e&&this.rememberDetection(t,e),e))).finally((()=>this.inflightDetect.delete(s)));return this.inflightDetect.set(s,n),n}async translate(t,e){await this.config_loader;const s=await this.getCurrentTabId();if(-1===s)return;let n=(new Date).getTime();this.channel.emitToTabs(s,"start_translating",{text:t,position:e,timestamp:n});let a=this.LANGUAGE_SETTING.sl,r=this.LANGUAGE_SETTING.tl;try{if("auto"!==a&&this.IN_MUTUAL_MODE)switch(a=await this.detect(t),a){case this.LANGUAGE_SETTING.sl:r=this.LANGUAGE_SETTING.tl;break;case this.LANGUAGE_SETTING.tl:r=this.LANGUAGE_SETTING.sl;break;default:a="auto",r=this.LANGUAGE_SETTING.tl}const e=this.DEFAULT_TRANSLATOR,i=this.makeTranslateKey(t,a,r,e),o=Date.now();this.lastTranslateKey===i&&(this.lastTranslateAt,this.cacheOptions.debounceWindowMs),this.lastTranslateKey=i,this.lastTranslateAt=o;let c=this.getTranslationFromCache(t,a,r,e);if(!c)if(this.inflightTranslate.has(i))c=await this.inflightTranslate.get(i);else{const s=this.TRANSLATORS[e].translate(t,a,r).then((s=>(s&&this.rememberTranslation(t,a,r,e,s),s))).finally((()=>this.inflightTranslate.delete(i)));this.inflightTranslate.set(i,s),c=await s}c.sourceLanguage=a,c.targetLanguage=r,this.channel.emitToTabs(s,"translating_finished",I({timestamp:n},c))}catch(t){this.channel.emitToTabs(s,"translating_error",{error:t,timestamp:n})}}async pronounce(t,e,s,n){await this.config_loader;const a=await this.getCurrentTabId();if(-1===a)return;let r=s,i=(new Date).getTime();this.channel.emitToTabs(a,"start_pronouncing",{pronouncing:t,text:e,language:s,timestamp:i});try{"auto"===s&&(r=await this.TRANSLATORS[this.DEFAULT_TRANSLATOR].detect(e)),this.channel.emitToTabs(a,"execute_tts",{pronouncing:t,text:e,language:r,speed:n,timestamp:i,translator:this.DEFAULT_TRANSLATOR})}catch(e){this.channel.emitToTabs(a,"pronouncing_error",{pronouncing:t,error:e,timestamp:i})}}async stopPronounce(){await this.config_loader;const t=await this.getCurrentTabId();-1!==t&&this.channel.emitToTabs(t,"stop_tts",{timestamp:(new Date).getTime()}),this.TRANSLATORS[this.DEFAULT_TRANSLATOR].stopPronounce()}getAvailableTranslators(t){return this.HYBRID_TRANSLATOR?["HybridTranslate"].concat(this.HYBRID_TRANSLATOR.getAvailableTranslatorsFor(t.from,t.to)):(console.log("HYBRID_TRANSLATOR not initialized yet"),["HybridTranslate"])}async onLanguageSettingUpdated(t){let e=this.DEFAULT_TRANSLATOR,s=this.getAvailableTranslators(t);const n=this.HYBRID_TRANSLATOR.updateConfigFor(t.from,t.to);chrome.storage.sync.set({HybridTranslatorConfig:n}),this.clearCaches(),new Set(s).has(e)||(e=s[1],chrome.storage.sync.set({DefaultTranslator:e})),this.channel.emit("hybrid_translator_config_updated",{config:n,availableTranslators:s.slice(1)}),O.query({active:!0,currentWindow:!0}).then((t=>this.channel.emitToTabs(t[0].id,"update_translator_options",{selectedTranslator:e,availableTranslators:s})))}updateDefaultTranslator(t){return new Promise((e=>{chrome.storage.sync.set({DefaultTranslator:t},(()=>{e()}))}))}}(Z);chrome.notifications&&"function"==typeof(null===(G=chrome.notifications.onClicked)||void 0===G?void 0:G.addListener)&&chrome.notifications.onClicked.addListener((t=>{switch(t){case"update_notification":chrome.tabs.create({url:"https://github.com/EdgeTranslate/EdgeTranslate/releases"});break;case"data_collection_notification":chrome.tabs.create({url:chrome.runtime.getURL("options/options.html#google-analytics")})}})),chrome.contextMenus.onClicked.addListener(((t,e)=>{switch(t.menuItemId){case"translate":Z.requestToTab(e.id,"get_selection").then((({text:t,position:e})=>t?tt.translate(t,e):Promise.reject())).catch((e=>t.selectionText.trim()?tt.translate(t.selectionText,null):Promise.resolve(e)));break;case"translate_page":x();break;case"translate_page_google":!function(t){O.query({active:!0,currentWindow:!0}).then((e=>{if(e[0]){if((()=>{if("undefined"==typeof navigator||!navigator.userAgent)return!1;const t=navigator.userAgent;return/Safari\//.test(t)&&!/Chrome\//.test(t)&&!/Chromium\//.test(t)&&!/Edg\//.test(t)})()&&chrome.scripting&&chrome.scripting.executeScript){const s=e[0].id;return void chrome.scripting.executeScript({target:{tabId:s,allFrames:!1},files:["google/init.js"],injectImmediately:!0}).then((()=>{t.emitToTabs(s,"start_page_translate",{translator:"google"}),setTimeout((()=>{try{t.emitToTabs(s,"start_dom_page_translate",{})}catch(t){}}),800)})).catch((()=>{try{chrome.tabs.executeScript(s,{file:"google/init.js"},(()=>{t.emitToTabs(s,"start_page_translate",{translator:"google"}),setTimeout((()=>{try{t.emitToTabs(s,"start_dom_page_translate",{})}catch(t){}}),800)}))}catch(e){t.emitToTabs(s,"inject_page_translate",{}),setTimeout((()=>{try{t.emitToTabs(s,"start_dom_page_translate",{})}catch(t){}}),800)}}))}if("undefined"!=typeof chrome&&chrome.scripting&&chrome.scripting.executeScript){const s=e[0].id;chrome.scripting.executeScript({target:{tabId:s},files:["google/init.js"]}).then((()=>{t.emitToTabs(s,"start_page_translate",{translator:"google"}),setTimeout((()=>{try{t.emitToTabs(s,"start_dom_page_translate",{})}catch(t){}}),800)})).catch((e=>{w(`Chrome scripting error: ${e}`),t.emitToTabs(s,"inject_page_translate",{})}))}else try{const s=e[0].id;chrome.tabs.executeScript(s,{file:"google/init.js"},(()=>{t.emitToTabs(s,"start_page_translate",{translator:"google"})}))}catch(s){t.emitToTabs(e[0].id,"inject_page_translate",{})}}}))}(Z);break;case"settings":chrome.runtime.openOptionsPage();break;case"shortcut":chrome.tabs.create({url:"chrome://extensions/shortcuts"});break;case"add_url_blacklist":U("urls",(()=>{F(["add_url_blacklist","add_domain_blacklist","remove_domain_blacklist"]),$(["remove_url_blacklist"])})),chrome.action.setBadgeText({text:H});break;case"remove_url_blacklist":q("urls",(()=>{F(["remove_url_blacklist","remove_domain_blacklist"]),$(["add_url_blacklist","add_domain_blacklist"])})),chrome.action.setBadgeText({text:""});break;case"add_domain_blacklist":U("domains",(()=>{F(["add_url_blacklist","add_domain_blacklist","remove_url_blacklist"]),$(["remove_domain_blacklist"])})),chrome.action.setBadgeText({text:H});break;case"remove_domain_blacklist":q("domains",((t,e)=>{t.urls[e]?(F(["add_url_blacklist","add_domain_blacklist","remove_domain_blacklist"]),$(["remove_url_blacklist"])):(F(["remove_url_blacklist","remove_domain_blacklist"]),$(["add_url_blacklist","add_domain_blacklist"]),chrome.action.setBadgeText({text:""}))}))}})),chrome.tabs.onActivated.addListener((t=>{chrome.tabs.get(t.tabId,(t=>{t.url&&t.url.length>0&&z(t.url)}))})),chrome.tabs.onUpdated.addListener(((t,e,s)=>{s.active&&s.url&&s.url.length>0&&z(s.url)})),Z.on("redirect",((t,e)=>chrome.tabs.update(e.tab.id,{url:t.url}))),Z.on("open_options_page",(()=>chrome.runtime.openOptionsPage())),Z.on("page_translate_event",((t,e)=>{try{t&&"page_moved"===t.event&&"number"==typeof t.distance&&t.distance>0&&Z.emitToTabs(e.tab.id,"page_translate_control",{action:"cancel_dom_fallback"})}catch(t){}Z.emitToTabs(e.tab.id,"page_translate_event",t)})),Z.provide("get_lang",(()=>Promise.resolve({lang:C[chrome.i18n.getUILanguage()]}))),chrome.commands.onCommand.addListener((t=>{"translate_page"===t?x():O.query({active:!0,currentWindow:!0}).then((e=>Z.emitToTabs(e[0].id,"command",{command:t}))).catch((()=>{}))})),"undefined"!=typeof self&&self.addEventListener&&(self.addEventListener("unhandledrejection",(t=>{var e,s;const n=(null===(e=t.reason)||void 0===e?void 0:e.message)||(null===(s=t.reason)||void 0===s?void 0:s.toString())||"";j(n)&&(w("Service Worker  Promise rejection:",n),t.preventDefault())})),self.addEventListener("error",(t=>{var e;const s=(null===(e=t.error)||void 0===e?void 0:e.message)||t.message||"";j(s)&&(w("Service Worker  :",s),t.preventDefault())})))})();