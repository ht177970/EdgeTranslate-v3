(()=>{"use strict";const e=new class{constructor(){this._services=new Map,this._eventManager=new class{constructor(){this._handlerID=1,this._eventToHandlerIDs=new Map,this._handlerIDToHandler=new Map}on(e,t){const r=this._allocHandlerID();this._handlerIDToHandler.set(r,t),this._eventToHandlerIDs.has(e)?this._eventToHandlerIDs.get(e).add(r):this._eventToHandlerIDs.set(e,new Set([r]));let n=!1;return(()=>{n?console.warn("You shouldn't call the canceler more than once!"):(n=!0,this._off(e,r))}).bind(this)}emit(e,t,r){const n=this._eventToHandlerIDs.get(e);if(n)for(const e of n){const n=this._handlerIDToHandler.get(e);n&&n(t,r)}}_allocHandlerID(){for(;this._handlerIDToHandler.has(this._handlerID);)this._handlerID=(this._handlerID+1)%Number.MAX_SAFE_INTEGER;return this._handlerID}_off(e,t){const r=this._eventToHandlerIDs.get(e);r&&r.delete(t),this._handlerIDToHandler.delete(t)}},chrome.runtime.onMessage.addListener(((e,t,r)=>{let n=JSON.parse(e);if(n&&n.type)switch(n.type){case"event":this._eventManager.emit(n.event,n.detail,t),r&&r();break;case"service":{const e=this._services.get(n.service);if(!e)break;return e(n.params,t).then((e=>r&&r(e))),!0}default:console.error(`Unknown message type: ${e.type}`)}else console.error(`Bad message: ${e}`)}).bind(this))}provide(e,t){this._services.set(e,t)}request(e,t){const r=JSON.stringify({type:"service",service:e,params:t});return new Promise(((e,t)=>{chrome.runtime.sendMessage(r,(r=>{chrome.runtime.lastError?t(chrome.runtime.lastError):e(r)}))}))}requestToTab(e,t,r){const n=this._getTabMessageSender();return n?n(e,JSON.stringify({type:"service",service:t,params:r})):Promise.reject("Can not send message to tabs in current context!")}on(e,t){return this._eventManager.on(e,t)}emit(e,t){let r=JSON.stringify({type:"event",event:e,detail:t});chrome.runtime.sendMessage(r,(()=>{chrome.runtime.lastError&&console.error(chrome.runtime.lastError)}))}emitToTabs(e,t,r){const n=this._getTabMessageSender();if(!n)return void console.error("Can not send message to tabs in current context!");"number"==typeof e&&(e=[e]);const s=JSON.stringify({type:"event",event:t,detail:r});for(let t of e)n(t,s).catch((e=>console.error(e)))}_getTabMessageSender(){return chrome.tabs&&chrome.tabs.sendMessage?(e,t)=>new Promise(((r,n)=>{chrome.tabs.sendMessage(e,t,(e=>{chrome.runtime.lastError?n(chrome.runtime.lastError):r(e)}))})):null}};e.on("inject_page_translate",(()=>{!async function(){try{const t=await new Promise((e=>{chrome.runtime.sendMessage(JSON.stringify({type:"service",service:"get_lang"}),(t=>e(t)))}));let r=document.getElementById("google-translate-injection");r&&r.remove();const n=t&&t.lang||"zh-CN";r=document.createElement("script"),r.id="google-translate-injection",r.src=`${chrome.runtime.getURL("")}google/injection.js`,r.setAttribute("user-lang",n),r.setAttribute("edge-translate-url",chrome.runtime.getURL("")),document.head.appendChild(r),e.emit("start_page_translate",{translator:"google"})}catch(e){}}()}))})();